<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Linux cgroup</title>
    <url>/posts/85b55b6f.html</url>
    <content><![CDATA[<h1 id="Linux-cgroup"><a href="#Linux-cgroup" class="headerlink" title="Linux cgroup"></a>Linux cgroup</h1><blockquote>
<p>å…¨æ–‡åŸºäº CentOS 7.4</p>
</blockquote>
<p>cgroup æ˜¯ Linux kernel çš„ä¸€é¡¹åŠŸèƒ½ï¼Œç”¨æ¥åšèµ„æºé™åˆ¶çš„<br>systemd æ˜¯ç®¡ç†è¿›ç¨‹çš„<br>cgroup å±‚çº§ç³»ç»Ÿ+ systemd å¯ä»¥æŠŠèµ„æºç®¡ç†è®¾ç½®ä»<strong>è¿›ç¨‹çº§åˆ«ç§»è‡³åº”ç”¨ç¨‹åºçº§åˆ«</strong></p>
<p>æœ¬æ–‡é¦–å…ˆå°†ä»‹ç»å¦‚ä½•åœ¨systemd ä¸­å¯¹åº”ç”¨åšèµ„æºé™åˆ¶<br>ç„¶åä»‹ç»å¦‚ä½•æ‰‹åŠ¨é…ç½® cgroup</p>
<a id="more"></a>

<h1 id="systemd-ä¸­-cgroup-çš„é»˜è®¤å±‚çº§"><a href="#systemd-ä¸­-cgroup-çš„é»˜è®¤å±‚çº§" class="headerlink" title="systemd ä¸­ cgroup çš„é»˜è®¤å±‚çº§"></a>systemd ä¸­ cgroup çš„é»˜è®¤å±‚çº§</h1><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œsystemd ä¼šåœ¨cgroupä¸‹è‡ªåŠ¨åˆ›å»º sliceã€scope å’Œ service å•ä½çš„å±‚çº§</p>
<ul>
<li>name.service<br>ä¸€ä¸ªæˆ–ä¸€ç»„è¿›ç¨‹</li>
<li>name.scope<br>ä¸€ç»„å¤–éƒ¨åˆ›å»ºçš„è¿›ç¨‹</li>
<li>parent-name.slice<br>ä¸€ç»„æŒ‰å±‚çº§æ’åˆ—çš„å•ä½ã€‚slice å¹¶ä¸åŒ…å«è¿›ç¨‹<br>å­å±‚æ ‡è¯†çˆ¶çš„åç§°</li>
</ul>
<p>ä½¿ç”¨ <code>systemd-cgls</code> å¯ä»¥æŸ¥çœ‹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">â”œâ”€1 /usr/lib/systemd/systemd --switched-root --system --deserialize 21</span><br><span class="line">â”œâ”€docker</span><br><span class="line">â”‚ â””â”€60684a93a27ee26bcc5dd062bb2d453ee9a409d665e01577f0061a0fe2cfd40a</span><br><span class="line">â”‚   â””â”€2922 mysqld</span><br><span class="line">â”œâ”€user.slice</span><br><span class="line">â”‚ â””â”€user-0.slice</span><br><span class="line">â”‚   â””â”€session-79.scope</span><br><span class="line">â”‚     â”œâ”€4527 sshd: root@pts/0    </span><br><span class="line">â”‚     â”œâ”€4529 -bash</span><br><span class="line">â”‚     â”œâ”€4584 systemd-cgls</span><br><span class="line">â”‚     â””â”€4585 less</span><br><span class="line">â””â”€system.slice</span><br><span class="line">  â”œâ”€docker.service</span><br><span class="line">  â”‚ â”œâ”€2671 /usr/bin/dockerd</span><br><span class="line">  â”‚ â”œâ”€2683 docker-containerd -l unix:///var/run/docker/libcontainerd/docker-containerd.sock --metrics-interval=0 --start-timeout 2m --state-dir /var/run/docker/libcontainerd/containerd --sh</span><br><span class="line">  â”‚ â”œâ”€2898 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 3306 -container-ip 172.20.0.2 -container-port 3306</span><br><span class="line">  â”‚ â””â”€2905 docker-containerd-shim 60684a93a27ee26bcc5dd062bb2d453ee9a409d665e01577f0061a0fe2cfd40a /var/run/docker/libcontainerd/60684a93a27ee26bcc5dd062bb2d453ee9a409d665e01577f0061a0fe2cf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>slice æ˜¯ä¸ªé€»è¾‘åˆ†ç»„ï¼Œserviceã€scopeæ‰æ˜¯è¿›ç¨‹è¿è¡Œçš„åœ°æ–¹</p>
</blockquote>
<h1 id="åœ¨systemd-ä¸­ä½¿ç”¨-cgroup"><a href="#åœ¨systemd-ä¸­ä½¿ç”¨-cgroup" class="headerlink" title="åœ¨systemd ä¸­ä½¿ç”¨ cgroup"></a>åœ¨systemd ä¸­ä½¿ç”¨ cgroup</h1><p>é¦–å…ˆsystemd å¯åŠ¨è¿›ç¨‹åˆ†ä¸ºä¸´æ—¶ã€æ°¸ä¹…ä¸¤ç§æ–¹å¼</p>
<p>ä¸´æ—¶ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemd-run --unit=name --scope --slice=slice_name <span class="built_in">command</span></span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨systemd-ç®¡ç†è¿›ç¨‹"><a href="#ä½¿ç”¨systemd-ç®¡ç†è¿›ç¨‹" class="headerlink" title="ä½¿ç”¨systemd ç®¡ç†è¿›ç¨‹"></a>ä½¿ç”¨systemd ç®¡ç†è¿›ç¨‹</h2><p>åˆ›å»ºä¸€ä¸ªæµ‹è¯•ä¾‹å­ï¼Œæ¥éªŒè¯cgroup å¯¹cpuçš„é™åˆ¶</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">tee /usr/lib/systemd/system/test.service&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/stress --cpu 10</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å¯åŠ¨åé€šè¿‡<code>top</code>å¯è§‚å¯Ÿåˆ°cpuå ç”¨ä¸º100%</p>
<h2 id="è®¾ç½®èµ„æºé™åˆ¶"><a href="#è®¾ç½®èµ„æºé™åˆ¶" class="headerlink" title="è®¾ç½®èµ„æºé™åˆ¶"></a>è®¾ç½®èµ„æºé™åˆ¶</h2><p>ä½¿ç”¨å‘½ä»¤å»ä¿®æ”¹ cgroup</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl set-property --runtime <span class="built_in">test</span> CPUQuota=10%</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸æ·»åŠ  <code>runtime</code> å‚æ•°ï¼Œè¿™ä¸ªèµ„æºé™åˆ¶ä¼šè¢«æŒä¹…åŒ–åˆ°æ–‡ä»¶</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /etc/systemd/system/test.service.d/50-CPUQuota.conf </span></span><br><span class="line">[Service]</span><br><span class="line">CPUQuota=10%</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶å€™å¯ç›´æ¥è§‚å¯Ÿåˆ°cpuå ç”¨é™ä½åˆ°10%</p>
<p>è¿™é‡Œåˆ—ä¸‹å¸¸ç”¨é…ç½®</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[Service]</span><br><span class="line"><span class="comment"># é»˜è®¤ 1024 ä»£è¡¨ 1core  ç›¸å¯¹ä½¿ç”¨ç‡</span></span><br><span class="line">CPUShares=1500</span><br><span class="line"><span class="comment"># å ç”¨æ¯”ä¾‹ æŒ‰å•æ ¸ç®—</span></span><br><span class="line">CPUQuota=110%</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ€å¤§å¯ç”¨å†…å­˜  å•ä½ï¼ˆKã€Mã€Gã€T ï¼‰</span></span><br><span class="line">MemoryLimit=1G</span><br></pre></td></tr></table></figure>



<p>æ›´å¤šè¯¦ç»†é…ç½®å‚è€ƒ<a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/resource_management_guide/sec-Modifying_Control_Groups#sec-Modifying_Unit_Files">ä¿®æ”¹ CGROUP</a></p>
<blockquote>
<p>cgroup = v1</p>
</blockquote>
<h1 id="cgroup-çš„æ‰‹åŠ¨é…ç½®"><a href="#cgroup-çš„æ‰‹åŠ¨é…ç½®" class="headerlink" title="cgroup çš„æ‰‹åŠ¨é…ç½®"></a>cgroup çš„æ‰‹åŠ¨é…ç½®</h1><p>å†…æ ¸ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæ¥é…ç½®cgroup</p>
<h2 id="hierarchy-å±‚çº§"><a href="#hierarchy-å±‚çº§" class="headerlink" title="hierarchy(å±‚çº§)"></a>hierarchy(å±‚çº§)</h2><p>é€šè¿‡è™šæ‹Ÿçš„æ–‡ä»¶ç³»ç»Ÿï¼Œç»´æŠ¤äº†ä¸€ä¸ªæ ‘<br>æè¿°äº†<code>cgroup</code>ä¹‹é—´çš„ä»å±å…³ç³»ï¼Œè¿™ç§ç»“æ„æ„å‘³ç€é…ç½®æ˜¯å¯ä»¥ç»§æ‰¿çš„<br>é€šè¿‡å†™å…¥æ ‘ä¸‹çš„æ–‡ä»¶ï¼Œå¯¹<code>cgroup</code>é…ç½®è¿›è¡Œä¿®æ”¹</p>
<blockquote>
<p>è¿™é‡Œåªå±•ç¤ºåˆ›å»º cgroup çš„å±‚çº§å…³ç³»ï¼ŒæŠŠè¿›ç¨‹æ·»åŠ åˆ°é‡Œé¢å»ï¼ˆä¸åŒ…å«èµ„æºé™åˆ¶ï¼‰</p>
</blockquote>
<h3 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç›®å½•ï¼Œå¹¶ä¸”æŒ‚è½½ä¸º cgroup ç±»å‹</span></span><br><span class="line">mkdir cgroup-test</span><br><span class="line">mount -t cgroup -o none,name=cgroup-test cgroup-test ./cgroup-test</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½åå¯ä»¥çœ‹åˆ°é‡Œé¢åˆ›å»ºçš„æ–‡ä»¶</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ls -1 ./cgroup-test/</span></span><br><span class="line">cgroup.clone_children   <span class="comment"># é»˜è®¤0ï¼Œå¦‚æœ1ï¼Œé‚£ä¹ˆå­cgroupä¼šç»§æ‰¿çˆ¶çš„é…ç½®</span></span><br><span class="line">cgroup.event_control    <span class="comment"># </span></span><br><span class="line">cgroup.procs            <span class="comment"># åŒ…å«ç³»ç»Ÿé‡Œæ‰€æœ‰è¿›ç¨‹</span></span><br><span class="line">cgroup.sane_behavior</span><br><span class="line">notify_on_release</span><br><span class="line">release_agent</span><br><span class="line">tasks                   <span class="comment"># å½“å‰ cgroup ä¸‹è¿›ç¨‹</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„åˆ° <code>-o none</code> æ„å‘³ç€è¿™ä¸ªæŒ‚è½½åç›®å½•æ˜¯è™šæ‹Ÿçš„</p>
<h3 id="åˆ›å»ºå­cgroup"><a href="#åˆ›å»ºå­cgroup" class="headerlink" title="åˆ›å»ºå­cgroup"></a>åˆ›å»ºå­cgroup</h3><p>åªéœ€è¦åœ¨<code>cgroup-test</code>ä¸­ åˆ›å»ºç›®å½•</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost cgroup-test]<span class="comment"># mkdir cgroup-1</span></span><br><span class="line">[root@localhost cgroup-test]<span class="comment"># mkdir cgroup-2</span></span><br><span class="line">[root@localhost cgroup-test]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ cgroup-1</span><br><span class="line">â”‚   â”œâ”€â”€ cgroup.clone_children</span><br><span class="line">â”‚   â”œâ”€â”€ cgroup.event_control</span><br><span class="line">â”‚   â”œâ”€â”€ cgroup.procs</span><br><span class="line">â”‚   â”œâ”€â”€ notify_on_release</span><br><span class="line">â”‚   â””â”€â”€ tasks</span><br><span class="line">â”œâ”€â”€ cgroup-2</span><br><span class="line">â”‚   â”œâ”€â”€ cgroup.clone_children</span><br><span class="line">â”‚   â”œâ”€â”€ cgroup.event_control</span><br><span class="line">â”‚   â”œâ”€â”€ cgroup.procs</span><br><span class="line">â”‚   â”œâ”€â”€ notify_on_release</span><br><span class="line">â”‚   â””â”€â”€ tasks</span><br><span class="line">â”œâ”€â”€ cgroup.clone_children</span><br><span class="line">â”œâ”€â”€ cgroup.event_control</span><br><span class="line">â”œâ”€â”€ cgroup.procs</span><br><span class="line">â”œâ”€â”€ cgroup.sane_behavior</span><br><span class="line">â”œâ”€â”€ notify_on_release</span><br><span class="line">â”œâ”€â”€ release_agent</span><br><span class="line">â””â”€â”€ tasks</span><br><span class="line"></span><br><span class="line">2 directories, 17 files</span><br></pre></td></tr></table></figure>

<h3 id="cgroupä¸­æ·»åŠ è¿›ç¨‹"><a href="#cgroupä¸­æ·»åŠ è¿›ç¨‹" class="headerlink" title="cgroupä¸­æ·»åŠ è¿›ç¨‹"></a>cgroupä¸­æ·»åŠ è¿›ç¨‹</h3><p>ç³»ç»Ÿæ‰€æœ‰è¿›ç¨‹éƒ½é»˜è®¤æŒ‚åœ¨æ ¹èŠ‚ç‚¹ä¸Š<br>æ·»åŠ è¿›ç¨‹é€šè¿‡å‘ <code>tasks</code> å†™å…¥<code>PID</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> $$ &gt;&gt; cgroup-1/tasks</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¯ä»¥åŠ å…¥åˆ° <code>cgroup-1</code>ä¸­</p>
<blockquote>
<p>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŠ å…¥åˆ°å¤šä¸ª<code>hierarchy</code>ä¸­</p>
</blockquote>
<p>ä¹‹å‰æåˆ°<code>systemd</code> ç»´æŠ¤çš„å±‚ï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿé‡Œ<code>/sys/fs/cgroup</code>  ä¸‹é¢<br>åƒ<code>/sys/fs/cgroup/systemd</code>ã€<code>/sys/fs/cgroup/cpu</code> è¿™äº›ç›®å½•éƒ½æ˜¯cgroupçš„å±‚çº§</p>
<h2 id="subsystem"><a href="#subsystem" class="headerlink" title="subsystem"></a>subsystem</h2><p>èµ„æºæ§åˆ¶çš„æ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—ä¸‹ä¼šæœ‰ä¸€ä¸ªcgroupçš„hierarchy<br>é€šè¿‡åœ¨ä¸åŒçš„hierarchyä¸­å¯¹æ–‡ä»¶è¿›è¡Œé…ç½®è¾¾åˆ°èµ„æºé™åˆ¶çš„æ•ˆæœ</p>
<h3 id="æŸ¥çœ‹ç³»ç»Ÿæ”¯æŒçš„æ¨¡å—"><a href="#æŸ¥çœ‹ç³»ç»Ÿæ”¯æŒçš„æ¨¡å—" class="headerlink" title="æŸ¥çœ‹ç³»ç»Ÿæ”¯æŒçš„æ¨¡å—"></a>æŸ¥çœ‹ç³»ç»Ÿæ”¯æŒçš„æ¨¡å—</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install -y libcgroup-tools</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># lssubsys -a</span></span><br><span class="line">cpuset</span><br><span class="line">cpu,cpuacct</span><br><span class="line">memory</span><br><span class="line">devices</span><br><span class="line">freezer</span><br><span class="line">net_cls,net_prio</span><br><span class="line">blkio</span><br><span class="line">perf_event</span><br><span class="line">hugetlb</span><br><span class="line">pids</span><br></pre></td></tr></table></figure>

<p>è¿™äº›æ¨¡å—ä¼šå¯¹æŒ‡å®šçš„èµ„æºåšé™åˆ¶ï¼Œé…ç½®è·¯å¾„åœ¨<code>/sys/fs/cgroup/&lt;cpu&gt;</code></p>
<h3 id="èµ„æºé™åˆ¶"><a href="#èµ„æºé™åˆ¶" class="headerlink" title="èµ„æºé™åˆ¶"></a>èµ„æºé™åˆ¶</h3><p>ä¹‹å‰åœ¨<code>systemd</code>é‡Œé¢å¯¹CPUåšäº†é™åˆ¶ï¼Œé‚£ä¹ˆå†å»çœ‹ä¸‹çœŸæ­£ç”Ÿæ•ˆçš„åœ°æ–¹<br>é‚£ä¹ˆæŸ¥çœ‹æ–‡ä»¶è·¯å¾„å¯ä»¥é€šè¿‡<code>systemd-cgls</code>æ‰¾åˆ°</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">â””â”€system.slice</span><br><span class="line">  â”œâ”€test.service</span><br><span class="line">  â”‚ â”œâ”€6094 /usr/bin/stress --cpu 10</span><br><span class="line">  â”‚ â””â”€6095 /usr/bin/stress --cpu 10</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>/sys/fs/cgroup/cpu/system.slice/test.service/</code> ä¸‹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat tasks </span></span><br><span class="line">6094</span><br><span class="line">6095</span><br><span class="line"><span class="comment"># å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªè¿›ç¨‹ç¡®å®åŠ å…¥åˆ°è¿™ä¸ªcgroupä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat cpu.cfs_period_us</span></span><br><span class="line">100000</span><br><span class="line"><span class="comment"># cat cpu.cfs_quota_us</span></span><br><span class="line">10000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>cpu.cfs_period_us: æŒ‡cgroupå¯¹èµ„æºè°ƒåº¦å‘¨æœŸ ï¼ˆå¾®ç§’ï¼‰<br>cpu.cfs_quota_usï¼š åœ¨ä¸€ä¸ªå‘¨æœŸï¼ˆcpu.cfs_period_uså®šä¹‰ï¼‰ï¼Œå¯ä»¥å ç”¨cpuçš„æ—¶é—´<br>ä¸€ä¸ªå‘¨æœŸå†…èƒ½å ç”¨å¤šå°‘cpu = cpu.cfs_quota_us / cpu.cfs_period_us<br>ä¹Ÿå°±æ˜¯è®¾ç½®çš„10%</p>
<p>ç„¶åè®¾ç½®ä¸ªå†…å­˜é™åˆ¶çœ‹çœ‹<br><code>systemctl set-property --runtime test MemoryLimit=128M</code><br>å°±å¯ä»¥åœ¨ä¸‹é¢è·¯å¾„çœ‹åˆ°</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cat /sys/fs/cgroup/memory/system.slice/test.service/memory.limit_in_bytes </span><br><span class="line">134217728</span><br></pre></td></tr></table></figure>


<p>systemd é‡Œé¢å‚æ•°å’Œå†…æ ¸ä¸­é…ç½®å¯¹åº”å…³ç³»</p>
<table>
<thead>
<tr>
<th>systemd option</th>
<th>cgroup</th>
</tr>
</thead>
<tbody><tr>
<td>CPUShares</td>
<td>cpu.shares</td>
</tr>
<tr>
<td>CPUQuota</td>
<td>cpu.cfs_quota_us</td>
</tr>
<tr>
<td>MemoryLimit</td>
<td>memory.limit_in_bytes</td>
</tr>
</tbody></table>
<h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><p>docker ä¼šç»™æ¯ä¸ªå®¹å™¨åˆ›å»º cgroupï¼Œä»¥<code>cpu</code>ä¸ºä¾‹å°±æ˜¯åœ¨<br><code>/sys/fs/cgroup/cpu/docker/</code></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/resource_management_guide/">èµ„æºç®¡ç†æŒ‡å—</a><br><a href="https://www.kernel.org/doc/Documentation/scheduler/sched-bwc.txt">CPUè°ƒåº¦å‚æ•°</a></p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>cgroup</tag>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS7 ä¸­ä¿®æ”¹ç½‘å¡åç§°</title>
    <url>/posts/1a6f476.html</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>CentOS7 å¼€å§‹ï¼Œç½‘å¡åç§°å˜ä¸ºéšæœºå€¼ï¼Œç”¨èµ·æ¥éå¸¸éº»çƒ¦<br>åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œç½‘ç»œåœ°å€ä¸€èˆ¬é…ç½®ä¸ºé™æ€ï¼Œç½‘å¡åç§°ä¹Ÿè¦å»ä¸€è‡´<br>æœ¬æ–‡è®°å½•æ‰‹åŠ¨ä¿®æ”¹åç§°çš„ä¸€ç§æ–¹å¼</p>
<blockquote>
<p>åŸºäºåŸç‰ˆCentOS 7.3.1611</p>
</blockquote>
<a id="more"></a>

<h2 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h2><p>ä»¥<code>eno16777736</code>ä¸ºä¾‹ï¼Œä¿®æ”¹ä¸º<code>eth0</code></p>
<h2 id="1-ä¿®æ”¹ifcfg-eno16777736"><a href="#1-ä¿®æ”¹ifcfg-eno16777736" class="headerlink" title="1. ä¿®æ”¹ifcfg-eno16777736"></a>1. ä¿®æ”¹ifcfg-eno16777736</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-eno16777736</span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">è®¾ç½®</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">PEERDNS=yes</span><br><span class="line">PEERROUTES=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line"><span class="deletion">- NAME=eno16777736</span></span><br><span class="line"><span class="addition">+ NAME=eth0</span></span><br><span class="line"><span class="deletion">- DEVICE=eno16777736</span></span><br><span class="line"><span class="addition">+ DEVICE=eth0</span></span><br><span class="line"><span class="addition">+ HWADDR=1f:1f:1f:1f:1f:1f</span></span><br><span class="line">IPADDR=10.33.100.100</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=10.33.100.254</span><br><span class="line">DNS1=8.8.8.8</span><br><span class="line">ONBOOT=yes</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦ç¡®ä¿ <code>HWADDR</code> è®¾ç½®ï¼Œå¦åˆ™åé¢ç»‘å®šä¸åˆ°ç‰©ç†ç½‘å¡ä¸Š</p>
<h2 id="2-æ–‡ä»¶é‡å‘½å"><a href="#2-æ–‡ä»¶é‡å‘½å" class="headerlink" title="2. æ–‡ä»¶é‡å‘½å"></a>2. æ–‡ä»¶é‡å‘½å</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/sysconfig/network-scripts/</span><br><span class="line">mv ifcfg-eno16777736 ifcfg-eth0</span><br></pre></td></tr></table></figure>

<h2 id="3-ä¿®æ”¹grub"><a href="#3-ä¿®æ”¹grub" class="headerlink" title="3. ä¿®æ”¹grub"></a>3. ä¿®æ”¹grub</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi /etc/default/grub</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ <code>net.ifnames=0 biosdevname=0</code>ä¸¤ä¸ªå‚æ•°</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">- GRUB_CMDLINE_LINUX=&quot;crashkernel=128M rhgb net.ifnames=0 biosdevname=0 quiet&quot;</span></span><br><span class="line"><span class="addition">+ GRUB_CMDLINE_LINUX=&quot;crashkernel=128M rhgb net.ifnames=0 biosdevname=0 quiet net.ifnames=0 biosdevname=0&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="4-è®©é…ç½®ç”Ÿæ•ˆ"><a href="#4-è®©é…ç½®ç”Ÿæ•ˆ" class="headerlink" title="4. è®©é…ç½®ç”Ÿæ•ˆ"></a>4. è®©é…ç½®ç”Ÿæ•ˆ</h2><p>è¿™é‡Œæ ¹æ®å¼•å¯¼ç±»å‹çš„ä¸åŒï¼Œä¼šæœ‰ä¸¤ç§å‘½ä»¤ï¼Œéƒ½æ‰§è¡Œå³å¯</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line">grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg</span><br></pre></td></tr></table></figure>

<h2 id="5-ä¿®æ”¹rulesæ–‡ä»¶"><a href="#5-ä¿®æ”¹rulesæ–‡ä»¶" class="headerlink" title="5. ä¿®æ”¹rulesæ–‡ä»¶"></a>5. ä¿®æ”¹rulesæ–‡ä»¶</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi /usr/lib/udev/rules.d/60-net.rules</span><br></pre></td></tr></table></figure>

<p>åˆ é™¤åŸæœ‰å†…å®¹ï¼Œç„¶åæ·»åŠ :</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, SUBSYSTEM==<span class="string">&quot;net&quot;</span>, DRIVERS==<span class="string">&quot;?*&quot;</span>, ATTR&#123;<span class="built_in">type</span>&#125;==<span class="string">&quot;1&quot;</span>, ATTR&#123;address&#125;==<span class="string">&quot;1f:1f:1f:1f:1f:1f&quot;</span>, NAME=<span class="string">&quot;eth0&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>âš ï¸macåœ°å€è¦å†™æ­£ç¡®<br>å¤šä¸ªç½‘å¡éƒ½è¦åœ¨è¿™é‡Œé…ç½®</p>
</blockquote>
<h3 id="6-é‡å¯"><a href="#6-é‡å¯" class="headerlink" title="6. é‡å¯"></a>6. é‡å¯</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">reboot now</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>centos</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS 7 å®‰è£… nvidia p4 é©±åŠ¨</title>
    <url>/posts/b79dc209.html</url>
    <content><![CDATA[<h1 id="CentOS-7-P4-é©±åŠ¨å®‰è£…"><a href="#CentOS-7-P4-é©±åŠ¨å®‰è£…" class="headerlink" title="CentOS 7 P4 é©±åŠ¨å®‰è£…"></a>CentOS 7 P4 é©±åŠ¨å®‰è£…</h1><h2 id="å®‰è£…å¿…å¤‡ç»„ä»¶"><a href="#å®‰è£…å¿…å¤‡ç»„ä»¶" class="headerlink" title="å®‰è£…å¿…å¤‡ç»„ä»¶"></a>å®‰è£…å¿…å¤‡ç»„ä»¶</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install gcc kernel-devel kernel-headers -y</span><br></pre></td></tr></table></figure>

<p>ğŸ‘†è¿™äº›ç»„ä»¶éƒ½éœ€è¦å’Œå½“å‰å†…æ ¸ç‰ˆæœ¬ä¸€è‡´ï¼Œç”šè‡³å’Œgcc ç‰ˆæœ¬éƒ½æœ‰å…³ç³»<br>ä¸ºäº†ç®€å•å¤„ç†ï¼Œå°±ç›´æ¥å‡çº§åˆ°<strong>æœ€æ–°</strong>ï¼Œç„¶åé‡å¯ç³»ç»Ÿ</p>
<a id="more"></a>

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum update kernel -y</span><br><span class="line">reboot now</span><br></pre></td></tr></table></figure>

<p>å‡çº§åå†…æ ¸æ˜¯<code>3.10.0-693.21.1.el7.x86_64</code></p>
<h2 id="Disabling-Nouveau"><a href="#Disabling-Nouveau" class="headerlink" title="Disabling Nouveau"></a>Disabling Nouveau</h2><p>æŸ¥çœ‹æ˜¯å¦å¯åŠ¨ï¼ˆæœ‰ä»»ä½•è¾“å‡ºï¼‰<br><code>lsmod | grep nouveau</code></p>
<p>ç¦ç”¨</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir -p /etc/modprobe.d</span><br><span class="line">tee /etc/modprobe.d/blacklist-nouveau.conf&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">blacklist nouveau</span></span><br><span class="line"><span class="string">options nouveau modeset=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sudo dracut --force</span><br></pre></td></tr></table></figure>
<p>ç„¶åé‡å¯å†ç¡®è®¤ä¸‹ï¼Œä¿è¯å…³é—­</p>
<h2 id="é©±åŠ¨"><a href="#é©±åŠ¨" class="headerlink" title="é©±åŠ¨"></a>é©±åŠ¨</h2><p><a href="http://www.nvidia.com/Download/index.aspx?lang=cn">æ‰¾é©±åŠ¨</a>ï¼ŒCentOS é€‰ <code>Linux 64</code>ï¼Œä¸è¦é€‰redhatçš„</p>
<p>ä¸‹å®Œæ˜¯ä¸€ä¸ª<code>run</code>æ–‡ä»¶</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">chmod +x NVIDIA-Linux-x86_64-390.46.run</span><br><span class="line"></span><br><span class="line">./NVIDIA-Linux-x86_64-390.46.run -q -a -n -X -s  --kernel-source-path=/usr/src/kernels/3.10.0-693.21.1.el7.x86_64  -k $(uname -r)</span><br></pre></td></tr></table></figure>

<p>å®‰è£…åä½¿ç”¨ <code>nvidia-smi</code> æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ</p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>centos</tag>
        <tag>gpu</tag>
        <tag>nvidia</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux ç½‘ç»œè™šæ‹ŸåŒ–</title>
    <url>/posts/706085c3.html</url>
    <content><![CDATA[<h1 id="Linux-ç½‘ç»œè™šæ‹ŸåŒ–"><a href="#Linux-ç½‘ç»œè™šæ‹ŸåŒ–" class="headerlink" title="Linux ç½‘ç»œè™šæ‹ŸåŒ–"></a>Linux ç½‘ç»œè™šæ‹ŸåŒ–</h1><p>æœ¬æ–‡ä¸»è¦è®°å½•Linux ä¸­ç½‘ç»œè™šæ‹ŸåŒ–ï¼Œä»¥åŠåŸºæœ¬çš„é…ç½®</p>
<p>å…¨æ–‡åŸºäº CentOS 7.4</p>
<a id="more"></a>
<h2 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h2><p>Namespace æŠ€æœ¯å¯ä»¥åˆ›å»ºç‹¬ç«‹çš„ç½‘ç»œç©ºé—´<br>ä½¿ç”¨ <code>ip netns</code> ç®¡ç†çš„ç½‘ç»œï¼Œå…¶è·¯å¾„åœ¨<code>/var/run/netns/</code>ï¼Œå¦‚æœæ˜¯dockeråˆ›å»ºçš„ç½‘ç»œç©ºé—´ï¼Œè¦åˆ›å»ºè½¯é“¾æ¥è¿‡å»ï¼Œæ‰èƒ½ç”¨è¿™ä¸ªæŒ‡ä»¤ç®¡ç†</p>
<h3 id="ç®¡ç†-Namespace"><a href="#ç®¡ç†-Namespace" class="headerlink" title="ç®¡ç† Namespace"></a>ç®¡ç† Namespace</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ  ns</span></span><br><span class="line">ip netns add net0</span><br><span class="line"><span class="comment"># æŸ¥çœ‹</span></span><br><span class="line">ip netns</span><br><span class="line"><span class="comment"># åœ¨æŒ‡å®šNSä¸­æ“ä½œ</span></span><br><span class="line">ip netns <span class="built_in">exec</span> net0 /bin/bash --rcfile &lt;(<span class="built_in">echo</span> <span class="string">&quot;PS1=\&quot;ns net0&gt; \&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># del</span></span><br><span class="line">ip netns del net0</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤åˆ›å»ºånsä¸­åªæœ‰ä¸€ä¸ªloçš„æ¥å£ï¼Œå¹¶ä¸”æ˜¯<code>down</code>ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œä¸èƒ½å’Œå…¶ä»–ä¸»æœºç½‘ç»œï¼Œå…¶ä»–nsé€šä¿¡</p>
<blockquote>
<p><code>netns</code> å¯ä»¥ç®€å†™ <code>net</code></p>
</blockquote>
<h2 id="veth"><a href="#veth" class="headerlink" title="veth"></a>veth</h2><p>veth æ˜¯<strong>æˆå¯¹</strong>å‡ºç°çš„ç½‘ç»œè®¾å¤‡ï¼Œä¸¤ä¸ªè™šæ‹Ÿè®¾å¤‡ä¹‹é—´ï¼Œæœ‰ä¸ªç›´é€šçš„é“¾è·¯</p>
<h3 id="ç®¡ç†veth"><a href="#ç®¡ç†veth" class="headerlink" title="ç®¡ç†veth"></a>ç®¡ç†veth</h3><p>åˆ›å»ºä¸€å¯¹<code>veth pair</code>ï¼Œè¿™åªèƒ½æˆå¯¹å‡ºç°</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ip link add <span class="built_in">type</span> veth</span><br><span class="line"><span class="comment"># æ‰‹åŠ¨æŒ‡å®šåç§°</span></span><br><span class="line">ip link add veth0 <span class="built_in">type</span> veth peer name veth1</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªä¹Ÿä¼šåˆ é™¤æ‰</span></span><br><span class="line">ip link del veth0</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºåå¯ä»¥çœ‹åˆ°</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">19: veth1@veth0: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000</span><br><span class="line">    link/ether f6:5f:3a:36:6e:73 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">20: veth0@veth1: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000</span><br><span class="line">    link/ether ea:53:eb:ff:d5:58 brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>

<h2 id="bridge"><a href="#bridge" class="headerlink" title="bridge"></a>bridge</h2><p>ç›¸å½“äºäº¤æ¢æœºï¼Œè¿æ¥ä¸åŒè®¾å¤‡ï¼Œä¾é <code>mac</code>åœ°å€åšè½¬å‘</p>
<h3 id="ç®¡ç†-bridge"><a href="#ç®¡ç†-bridge" class="headerlink" title="ç®¡ç† bridge"></a>ç®¡ç† bridge</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># add</span></span><br><span class="line">ip link add br0 <span class="built_in">type</span> bridge</span><br><span class="line"></span><br><span class="line"><span class="comment"># up</span></span><br><span class="line">ip link <span class="built_in">set</span> dev br0 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠŠè®¾å¤‡æŒ‚ä¸Šå»</span></span><br><span class="line">ip link <span class="built_in">set</span> dev eth1 master br0</span><br><span class="line"><span class="comment"># å–ä¸‹æ¥</span></span><br><span class="line">ip link <span class="built_in">set</span> dev eth1 nomaster</span><br></pre></td></tr></table></figure>

<h2 id="ns-ä¹‹é—´é€šä¿¡"><a href="#ns-ä¹‹é—´é€šä¿¡" class="headerlink" title="ns ä¹‹é—´é€šä¿¡"></a>ns ä¹‹é—´é€šä¿¡</h2><p>ä¸¤ä¸ªnsä¹‹é—´å¯ä»¥é€šè¿‡<code>veth pair</code>è¿›è¡Œé€šä¿¡ï¼Œæ„æ€å°±æ˜¯åœ¨ä¸¤ä¸ªç©ºé—´ä¸­åŠ äº†ä¸ªç®¡é“ï¼Œæ‹“æ‰‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+++++++++++++++++    +++++++++++++++++</span><br><span class="line">+      ns0      +    +      ns1      +</span><br><span class="line">+  -----------  +    +  -----------  +</span><br><span class="line">+  |  veth0  |----------|  veth1  |  +</span><br><span class="line">+  -----------  +    +  -----------  +</span><br><span class="line">+++++++++++++++++    +++++++++++++++++</span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ›å»ºveth</li>
<li>æ”¾å…¥ns</li>
</ul>
<h3 id="åˆ›å»ºveth"><a href="#åˆ›å»ºveth" class="headerlink" title="åˆ›å»ºveth"></a>åˆ›å»ºveth</h3><p>æ¥ğŸ‘†</p>
<h3 id="æ”¾å…¥ns"><a href="#æ”¾å…¥ns" class="headerlink" title="æ”¾å…¥ns"></a>æ”¾å…¥ns</h3><p>é¦–å…ˆè¦æŠŠvethæ”¾å…¥å„è‡ªnsä¸­</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ip link <span class="built_in">set</span> veth0 netns net0</span><br><span class="line">ip link <span class="built_in">set</span> veth1 netns net1</span><br></pre></td></tr></table></figure>

<p>ç„¶åéœ€è¦é…ç½®ipåœ°å€</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ip netns <span class="built_in">exec</span> net0 ip addr add 192.168.1.1/24 dev veth0</span><br><span class="line">ip netns <span class="built_in">exec</span> net1 ip addr add 192.168.1.2/24 dev veth1</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œåªè¦æ“ä½œä¸€ä¸ªæ¥å£çŠ¶æ€ï¼Œå¦å¤–ä¸€ä¸ªä¼šåŒæ­¥å˜åŒ–</span></span><br><span class="line">ip netns <span class="built_in">exec</span> net0 ip link <span class="built_in">set</span> veth0 up</span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨bridgeè¿æ¥ä¸åŒns"><a href="#ä½¿ç”¨bridgeè¿æ¥ä¸åŒns" class="headerlink" title="ä½¿ç”¨bridgeè¿æ¥ä¸åŒns"></a>ä½¿ç”¨bridgeè¿æ¥ä¸åŒns</h2><p><code>veth pair</code>åªèƒ½è¿æ¥ä¸¤ä¸ªnsï¼Œå½“å¤šä¸ªnsè¦é€šä¿¡æ—¶å€™éœ€è¦ä½¿ç”¨<code>bridge</code><br>æ‹“æ‰‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+++++++++++++++++    +++++++++++++++++</span><br><span class="line">+      ns0      +    +      ns1      +</span><br><span class="line">+  -----------  +    +  -----------  +</span><br><span class="line">+  |  veth1  |  +    +  |  veth3  |  +</span><br><span class="line">+  -----------  +    +  -----------  +</span><br><span class="line">+++++++ | +++++++    +++++++ | +++++++</span><br><span class="line">        |                    |</span><br><span class="line">        |--------------------|</span><br><span class="line">                  ||</span><br><span class="line">          &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">          &#x3D;      br0      &#x3D;</span><br><span class="line">          &#x3D;               &#x3D;</span><br><span class="line">          &#x3D; veth0   veth2 &#x3D;</span><br><span class="line">          &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">           </span><br></pre></td></tr></table></figure>

<h3 id="åˆ›å»ºbridge"><a href="#åˆ›å»ºbridge" class="headerlink" title="åˆ›å»ºbridge"></a>åˆ›å»ºbridge</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ </span></span><br><span class="line">ip link add br0 <span class="built_in">type</span> bridge</span><br><span class="line"><span class="comment"># å¹¶ä¸”up</span></span><br><span class="line">ip link <span class="built_in">set</span> dev br0 up</span><br></pre></td></tr></table></figure>

<h3 id="åˆ›å»ºveth-1"><a href="#åˆ›å»ºveth-1" class="headerlink" title="åˆ›å»ºveth"></a>åˆ›å»ºveth</h3><p>åˆ›å»º vethï¼Œå¹¶ä¸”ä¸€ç«¯åŠ å…¥nsï¼Œä¸€ç«¯è¿æ¥ bridge</p>
<p>é¦–å…ˆå’Œä¹‹å‰ä¸€æ ·åˆ›å»º<code>veth</code>ï¼Œå‡è®¾å·²ç»åˆ›å»ºäº†ä¸¤å¯¹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">veth0@veth1</span><br><span class="line">veth2@veth3</span><br></pre></td></tr></table></figure>

<h3 id="ç»‘å®š"><a href="#ç»‘å®š" class="headerlink" title="ç»‘å®š"></a>ç»‘å®š</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŠŠè®¾å¤‡ veth0 åŠ å…¥åˆ° br0</span></span><br><span class="line">ip link <span class="built_in">set</span> dev veth0 master br0</span><br><span class="line">ip link <span class="built_in">set</span> dev veth1 netns net0</span><br><span class="line">ip link <span class="built_in">set</span> dev veth2 master br0</span><br><span class="line">ip link <span class="built_in">set</span> dev veth3 netns net1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> net0 ip link <span class="built_in">set</span> dev veth1 name eth0</span><br><span class="line">ip netns <span class="built_in">exec</span> net0 ip addr add 192.168.1.2/24 dev eth0</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> net1 ip link <span class="built_in">set</span> dev veth3 name eth0</span><br><span class="line">ip netns <span class="built_in">exec</span> net1 ip addr add 192.168.1.3/24 dev eth0</span><br><span class="line"></span><br><span class="line">ip link <span class="built_in">set</span> dev veth0 up</span><br><span class="line">ip link <span class="built_in">set</span> dev veth2 up</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> net0 ip link <span class="built_in">set</span> dev eth0 up</span><br><span class="line">ip netns <span class="built_in">exec</span> net1 ip link <span class="built_in">set</span> dev eth0 up</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://cizixs.com/2017/02/10/network-virtualization-network-namespace">linux ç½‘ç»œè™šæ‹ŸåŒ–ï¼š network namespace ç®€ä»‹</a></p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>docker</tag>
        <tag>net</tag>
        <tag>virt</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes ä¸­çš„RBAC</title>
    <url>/posts/bfe9b98e.html</url>
    <content><![CDATA[<h1 id="kubernetes-RBAC"><a href="#kubernetes-RBAC" class="headerlink" title="kubernetes RBAC"></a>kubernetes RBAC</h1><p>è§’è‰²ç»‘å®šå°†è§’è‰²æ˜ å°„åˆ°ä¸€ä¸ªç”¨æˆ·æˆ–è€…ä¸€ç»„ç”¨æˆ·ï¼ŒæŠŠè§’è‰²åœ¨å‘½åç©ºé—´ä¸­å¯¹èµ„æºçš„æƒé™æˆæƒç»™è¿™äº›ç”¨æˆ·ã€‚ClusterRoleBindingï¼ˆé›†ç¾¤è§’è‰²ç»‘å®šï¼‰å…è®¸æˆæƒç”¨æˆ·ClusterRoleçš„åœ¨æ•´ä¸ªé›†ç¾¤ä¸­çš„æˆæƒè®¿é—®ã€‚</p>
<p>RBAC APIå®šä¹‰äº†å››ä¸ªèµ„æºå¯¹è±¡ç”¨äºæè¿°è§’è‰²å’Œæƒé™ã€è§’è‰²å’Œç”¨æˆ·çš„å…³ç³»ï¼š</p>
<ul>
<li>Role</li>
<li>ClusterRole</li>
<li>RoleBinding</li>
<li>ClusterRoleBinding</li>
</ul>
<a id="more"></a>
<h2 id="Role-å’Œ-ClusterRole"><a href="#Role-å’Œ-ClusterRole" class="headerlink" title="Role å’Œ ClusterRole"></a>Role å’Œ ClusterRole</h2><p>æè¿°è§’è‰²å’Œæƒé™çš„å…³ç³»</p>
<p>Roles æ˜¯é™å®šåœ¨æŸä¸ªNamespaceä¸‹çš„<br><code>kubectl get roles --all-namespaces</code></p>
<p>ClusterRole æ˜¯æ•´ä¸ªé›†ç¾¤èŒƒå›´çš„<br><code>kubectl get clusterroles</code></p>
<h3 id="èµ„æºç¤ºä¾‹"><a href="#èµ„æºç¤ºä¾‹" class="headerlink" title="èµ„æºç¤ºä¾‹"></a>èµ„æºç¤ºä¾‹</h3><p>ä¸€æ¡è§„åˆ™ç”± <code>apiGroups</code>ã€<code>resources</code>ã€<code>verbs</code> å…±åŒç»„æˆï¼Œç»“æ„å¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>] <span class="comment"># &quot;&quot; indicates the core API group</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>ClusterRole åœ¨èµ„æºç»“æ„ä¸Šç±»ä¼¼</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># ä¸èƒ½æœ‰&quot;namespace&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>
<h2 id="RoleBinding-å’Œ-ClusterRoleBinding"><a href="#RoleBinding-å’Œ-ClusterRoleBinding" class="headerlink" title="RoleBinding å’Œ ClusterRoleBinding"></a>RoleBinding å’Œ ClusterRoleBinding</h2><p>æè¿° subjects ï¼ˆåŒ…å«users, groups, service accountsï¼‰å’Œ è§’è‰²çš„å…³ç³»</p>
<p>RoleBinding æ˜¯é™å®šåœ¨æŸä¸ªNamespaceä¸‹çš„<br><code>kubectl get rolebinding --all-namespaces</code></p>
<p>ClusterRoleBinding æ˜¯æ•´ä¸ªé›†ç¾¤èŒƒå›´çš„<br><code>kubectl get clusterrolebinding</code></p>
<h3 id="èµ„æºç¤ºä¾‹-1"><a href="#èµ„æºç¤ºä¾‹-1" class="headerlink" title="èµ„æºç¤ºä¾‹"></a>èµ„æºç¤ºä¾‹</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># This role binding allows &quot;jane&quot; to read pods in the &quot;default&quot; namespace.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-pods</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jane</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># This cluster role binding allows anyone in the &quot;manager&quot; group to read secrets in any namespace.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets-global</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">manager</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<h3 id="subjects-ä½¿ç”¨ç¤ºä¾‹"><a href="#subjects-ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="subjects ä½¿ç”¨ç¤ºä¾‹"></a>subjects ä½¿ç”¨ç¤ºä¾‹</h3><p>subjects æ˜¯è®¿é—®api çš„ä¸»ä½“<br>ä¹‹å‰æåˆ° subjects åŒ…å«users, groups, service accounts ä¸‰ç§ç±»å‹ï¼Œä¸‹é¢å±•ç¤ºä¸‹å…·ä½“å†™æ³•</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;nil@example.com&quot;</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;frontend-admins&quot;</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç°æœ‰ç¯å¢ƒï¼Œk8s ç»„ä»¶è®¿é—® apiserver ä½¿ç”¨åŸºäºè¯ä¹¦çš„è®¤è¯æ–¹å¼(åŒå‘)ï¼Œapiserver æ¥å—è¯·æ±‚æ—¶ä¼šä»client è¯ä¹¦ä¸­æå–<br><code>CN</code>ã€<code>O</code>å­—æ®µï¼Œåˆ†åˆ«ä½œä¸º <code>subjects</code> ä¸­çš„ <code>User</code> å’Œ <code>Group</code></p>
<p>ä¸‹é¢æ˜¯<code>kube-proxy</code>è¯ä¹¦é…ç½®çš„ç¤ºä¾‹ï¼Œé…å†…å®¹å¯ä»¥æŸ¥é˜…<a href="https://kubernetes.io/docs/admin/authorization/rbac/#discovery-roles">æ–‡æ¡£</a></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;CN&quot;</span>: <span class="string">&quot;system:kube-proxy&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;hosts&quot;</span>: [<span class="string">&quot;&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;key&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;size&quot;</span>: <span class="number">2048</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;names&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;O&quot;</span>: <span class="string">&quot;system:nodes&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è‡³äºé›†ç¾¤å†…è®¿é—® apiserver å‡ä½¿ç”¨service accounts æ¥è¡¨ç¤ºèº«ä»½</p>
<h2 id="Kubernetesä¸­é»˜è®¤çš„Roleå’ŒRoleBinding"><a href="#Kubernetesä¸­é»˜è®¤çš„Roleå’ŒRoleBinding" class="headerlink" title="Kubernetesä¸­é»˜è®¤çš„Roleå’ŒRoleBinding"></a>Kubernetesä¸­é»˜è®¤çš„Roleå’ŒRoleBinding</h2><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªæŒ‡ä»¤æŸ¥çœ‹é»˜è®¤çš„æƒé™è®¾ç½®<br><code>kubectl get clusterrole -l kubernetes.io/bootstrapping=rbac-defaults</code></p>
<p><code>kubectl get clusterrolebinding -l kubernetes.io/bootstrapping=rbac-defaults</code></p>
<h2 id="åˆ›å»ºclusterrolebinding-ç¤ºä¾‹"><a href="#åˆ›å»ºclusterrolebinding-ç¤ºä¾‹" class="headerlink" title="åˆ›å»ºclusterrolebinding ç¤ºä¾‹"></a>åˆ›å»ºclusterrolebinding ç¤ºä¾‹</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding admin \</span><br><span class="line">--clusterrole=cluster-admin \</span><br><span class="line">--user=system:kube-controller-manager \</span><br><span class="line">--user=system:kube-scheduler \</span><br><span class="line">--group=system:kube-controller-manager</span><br></pre></td></tr></table></figure>




]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>NIC ä½¿ç”¨ sr-iov</title>
    <url>/posts/ccd392c5.html</url>
    <content><![CDATA[<h1 id="SR-IOV-ç½‘å¡ç›´é€š"><a href="#SR-IOV-ç½‘å¡ç›´é€š" class="headerlink" title="SR-IOV ç½‘å¡ç›´é€š"></a>SR-IOV ç½‘å¡ç›´é€š</h1><p>SR-IOVæ˜¯ä¸€ç§åŸºäºç¡¬ä»¶çš„è™šæ‹ŸåŒ–æ–¹æ¡ˆã€‚ç”¨æ¥ä½¿ä¸€ä¸ªPCIeçš„ç‰©ç†è®¾å¤‡ï¼Œèƒ½è™šæ‹Ÿå‡ºå¤šä¸ªè®¾å¤‡ã€‚</p>
<p>SR-IOV ä¸­çš„ä¸¤ç§æ–°åŠŸèƒ½ç±»å‹æ˜¯ï¼š</p>
<ul>
<li><p>ç‰©ç†åŠŸèƒ½ (Physical Function, PF)<br>åŒ…æ‹¬ç®¡ç†SR-IOVåŠŸèƒ½åœ¨å†…çš„æ‰€æœ‰PCIe function</p>
</li>
<li><p>è™šæ‹ŸåŠŸèƒ½ (Virtual Function, VF)<br>VF æ˜¯ä¸€ç§è½»é‡çº§ PCIe åŠŸèƒ½ï¼ŒVF ä»…å…è®¸æ‹¥æœ‰ç”¨äºå…¶è‡ªèº«è¡Œä¸ºçš„é…ç½®èµ„æºã€‚</p>
</li>
</ul>
<p>æ¯ä¸ª SR-IOV è®¾å¤‡éƒ½å¯æœ‰ä¸€ä¸ªç‰©ç†åŠŸèƒ½ (Physical Function, PF)ï¼Œå¹¶ä¸”æ¯ä¸ª PF æœ€å¤šå¯æœ‰ 64,000 ä¸ªä¸å…¶å…³è”çš„è™šæ‹ŸåŠŸèƒ½ (Virtual Function, VF)ã€‚PF å¯ä»¥é€šè¿‡å¯„å­˜å™¨åˆ›å»º VFï¼Œè¿™äº›å¯„å­˜å™¨è®¾è®¡æœ‰ä¸“ç”¨äºæ­¤ç›®çš„çš„å±æ€§ã€‚</p>
<p>ä¸€æ—¦åœ¨ PF ä¸­å¯ç”¨äº† SR-IOVï¼Œå°±å¯ä»¥é€šè¿‡ PF çš„æ€»çº¿ã€è®¾å¤‡å’ŒåŠŸèƒ½ç¼–å·ï¼ˆè·¯ç”± IDï¼‰è®¿é—®å„ä¸ª VF çš„ PCI é…ç½®ç©ºé—´ã€‚æ¯ä¸ª VF éƒ½å…·æœ‰ä¸€ä¸ª PCI å†…å­˜ç©ºé—´ï¼Œç”¨äºæ˜ å°„å…¶å¯„å­˜å™¨é›†ã€‚VF è®¾å¤‡é©±åŠ¨ç¨‹åºå¯¹å¯„å­˜å™¨é›†è¿›è¡Œæ“ä½œä»¥å¯ç”¨å…¶åŠŸèƒ½ï¼Œå¹¶ä¸”æ˜¾ç¤ºä¸ºå®é™…å­˜åœ¨çš„ PCI è®¾å¤‡ã€‚åˆ›å»º VF åï¼Œå¯ä»¥ç›´æ¥å°†å…¶æŒ‡å®šç»™ IO æ¥å®¾åŸŸæˆ–å„ä¸ªåº”ç”¨ç¨‹åºï¼ˆå¦‚è£¸æœºå¹³å°ä¸Šçš„ Oracle Solaris Zonesï¼‰ã€‚æ­¤åŠŸèƒ½ä½¿å¾—è™šæ‹ŸåŠŸèƒ½å¯ä»¥å…±äº«ç‰©ç†è®¾å¤‡ï¼Œå¹¶åœ¨æ²¡æœ‰ CPU å’Œè™šæ‹Ÿæœºç®¡ç†ç¨‹åºè½¯ä»¶å¼€é”€çš„æƒ…å†µä¸‹æ‰§è¡Œ I/Oã€‚</p>
<a id="more"></a>
<h2 id="CentOS-7-å¼€å¯"><a href="#CentOS-7-å¼€å¯" class="headerlink" title="CentOS 7 å¼€å¯"></a>CentOS 7 å¼€å¯</h2><p>å¼€å¯<code>VF</code>å¤§æ¦‚éœ€è¦è¿™å‡ æ­¥ï¼š</p>
<ol>
<li>ç¡¬ä»¶æ”¯æŒ</li>
<li>BIOS å¼€å¯ SR-IOV ã€VT</li>
<li>å¼€å¯IOMMU</li>
<li>é…ç½®PF</li>
</ol>
<blockquote>
<p>å…¨æ–‡åŸºäº Intel CPU</p>
</blockquote>
<h3 id="æŸ¥çœ‹CPUæ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–"><a href="#æŸ¥çœ‹CPUæ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–" class="headerlink" title="æŸ¥çœ‹CPUæ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–"></a>æŸ¥çœ‹CPUæ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">egrep -c <span class="string">&#x27;(vmx|svm)&#x27;</span> /proc/cpuinfo</span><br></pre></td></tr></table></figure>
<p>å¦‚æœ <code>&gt;0</code>åˆ™æ”¯æŒ</p>
<p>ç„¶ååœ¨ BIOS ä¸­å¼€å¯ <code>enable  VT</code>å’Œ<code>Intel VT-d</code></p>
<h3 id="å¯ç”¨IOMMU"><a href="#å¯ç”¨IOMMU" class="headerlink" title="å¯ç”¨IOMMU"></a>å¯ç”¨<code>IOMMU</code></h3><p>ä¿®æ”¹<code>/etc/default/grub</code><br>åœ¨<code>GRUB_CMDLINE_LINUX</code>åé¢æ·»åŠ <code>intel_iommu=on</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX=<span class="string">&quot;crashkernel=auto biosdevname=0 net.ifnames=0 rhgb quiet intel_iommu=on&quot;</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åç”Ÿæˆå¼•å¯¼&amp;é‡å¯</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">grub2-mkconfig  -o /boot/grub2/grub.cfg</span><br><span class="line">reboot now</span><br></pre></td></tr></table></figure>

<p>é‡å¯åæ£€æŸ¥<code>IOMMU</code>æ˜¯å¦å¯ç”¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# dmesg | grep -e DMAR -e IOMMU</span><br><span class="line">...</span><br><span class="line">[    0.000000] DMAR: IOMMU enabled</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="æŸ¥çœ‹ç½‘å¡æ”¯æŒè™šæ‹Ÿçš„æ•°é‡"><a href="#æŸ¥çœ‹ç½‘å¡æ”¯æŒè™šæ‹Ÿçš„æ•°é‡" class="headerlink" title="æŸ¥çœ‹ç½‘å¡æ”¯æŒè™šæ‹Ÿçš„æ•°é‡"></a>æŸ¥çœ‹ç½‘å¡æ”¯æŒè™šæ‹Ÿçš„æ•°é‡</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cat /sys/class/net/eth0/device/sriov_totalvfs</span><br></pre></td></tr></table></figure>

<h3 id="åˆ›å»ºè™šæ‹Ÿç½‘å¡"><a href="#åˆ›å»ºè™šæ‹Ÿç½‘å¡" class="headerlink" title="åˆ›å»ºè™šæ‹Ÿç½‘å¡"></a>åˆ›å»ºè™šæ‹Ÿç½‘å¡</h3><p>ä»¥<code>eth0</code>ä¸ºä¾‹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;7&#x27;</span> &gt; /sys/class/net/eth0/device/sriov_numvfs</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ£€æŸ¥æ˜¯å¦åˆ›å»ºæˆåŠŸ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# lspci|grep Ethernet</span><br><span class="line">01:00.0 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01)</span><br><span class="line">01:00.1 Ethernet controller: Intel Corporation I350 Gigabit Network Connection (rev 01)</span><br><span class="line">01:10.0 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01)</span><br><span class="line">01:10.4 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01)</span><br><span class="line">01:11.0 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01)</span><br><span class="line">01:11.4 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01)</span><br><span class="line">01:12.0 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01)</span><br><span class="line">01:12.4 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01)</span><br><span class="line">01:13.0 Ethernet controller: Intel Corporation I350 Ethernet Controller Virtual Function (rev 01)</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªé…ç½®éæŒä¹…åŒ–</p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>sr-iov</tag>
      </tags>
  </entry>
  <entry>
    <title>cert</title>
    <url>/posts/caa206b.html</url>
    <content><![CDATA[<h2 id="è¯ä¹¦å†…å®¹"><a href="#è¯ä¹¦å†…å®¹" class="headerlink" title="è¯ä¹¦å†…å®¹"></a>è¯ä¹¦å†…å®¹</h2><p>å¸¸ç”¨å°±æ˜¯<code>x509</code> è§£è¯ä¹¦çœ‹å†…å®¹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">openssl x509 -noout -<span class="keyword">in</span> ca.cer -text</span><br></pre></td></tr></table></figure>

<p>å…¶ä»–çš„è¯ä¹¦ç”Ÿæˆï¼Œèµ° <code>cfssl</code> å·¥å…·</p>
<h2 id="Letâ€™s-Encrypt-DNS-æ¨¡å¼è®¤è¯"><a href="#Letâ€™s-Encrypt-DNS-æ¨¡å¼è®¤è¯" class="headerlink" title="Letâ€™s Encrypt DNS æ¨¡å¼è®¤è¯"></a>Letâ€™s Encrypt DNS æ¨¡å¼è®¤è¯</h2><a id="more"></a>
<p>DNS æ¨¡å¼éªŒè¯ç­¾å‘è¯ä¹¦å¯ä»¥å®Œç¾é¿å¼€<code>80</code>ç«¯å£é™åˆ¶<br>åŸç†å°±æ˜¯æ·»åŠ ä¸€æ¡TXTè®°å½•ï¼ŒéªŒè¯åŸŸåæ‰€æœ‰æƒ</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl  https://get.acme.sh | sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /root/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> Ali_Key=<span class="string">&quot;AK&quot;</span></span><br><span class="line"><span class="built_in">export</span> Ali_Secret=<span class="string">&quot;SK&quot;</span></span><br><span class="line"><span class="comment"># ç­¾å‘</span></span><br><span class="line">acme.sh --issue  --dns dns_ali -d <span class="string">&#x27;www.example.com&#x27;</span> -d <span class="string">&#x27;example.com&#x27;</span> --yes-I-know-dns-manual-mode-enough-go-ahead-please</span><br><span class="line"></span><br><span class="line"><span class="comment"># åé¢å®šæœŸæ›´æ–°</span></span><br><span class="line">acme.sh --renew  --dns dns_ali -d <span class="string">&#x27;www.example.com&#x27;</span> -d <span class="string">&#x27;example.com&#x27;</span> --yes-I-know-dns-manual-mode-enough-go-ahead-please</span><br></pre></td></tr></table></figure>

<blockquote>
<p>DNS éƒ¨åˆ†éœ€è¦å¯¹æ¥ä¸åŒæœåŠ¡çš„API,æˆ‘è¿™é‡Œç”¨ç€aliyun çš„<br>å…¶ä»–å¯ä»¥å‚è€ƒ <a href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi">https://github.com/acmesh-official/acme.sh/wiki/dnsapi</a></p>
</blockquote>
]]></content>
      <categories>
        <category>cheatbook</category>
      </categories>
      <tags>
        <tag>cert</tag>
      </tags>
  </entry>
  <entry>
    <title>Git</title>
    <url>/posts/69c3279c.html</url>
    <content><![CDATA[<h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><h2 id="å¯†ç ä¸­ç‰¹æ®Šå­—ç¬¦"><a href="#å¯†ç ä¸­ç‰¹æ®Šå­—ç¬¦" class="headerlink" title="å¯†ç ä¸­ç‰¹æ®Šå­—ç¬¦"></a>å¯†ç ä¸­ç‰¹æ®Šå­—ç¬¦</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">!   <span class="comment">#   $    &amp;   &#x27;   (   )   *   +   ,   /   :   ;   =   ?   @   [   ]</span></span><br><span class="line">%21 %23 %24 %26 %27 %28 %29 %2A %2B %2C %2F %3A %3B %3D %3F %40 %5B %5D</span><br></pre></td></tr></table></figure>

<a id="more"></a>
<h2 id="proxy"><a href="#proxy" class="headerlink" title="proxy"></a>proxy</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># http</span></span><br><span class="line">git config --global http.proxy http://127.0.0.1:1080</span><br><span class="line">git config --global https.proxy http://127.0.0.1:1080</span><br><span class="line"></span><br><span class="line"><span class="comment"># socks5</span></span><br><span class="line">git config --global http.proxy <span class="string">&quot;socks5://127.0.0.1:1080&quot;</span></span><br><span class="line">git config --global https.proxy <span class="string">&quot;socks5://127.0.0.1:1080&quot;</span></span><br><span class="line"></span><br><span class="line">git config --global --<span class="built_in">unset</span> http.proxy</span><br><span class="line">git config --global --<span class="built_in">unset</span> https.proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh</span></span><br><span class="line">tee ~/.ssh/config&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">Host github.com</span></span><br><span class="line"><span class="string">    ProxyCommand connect -H 127.0.0.1:1080 %h 22</span></span><br><span class="line"><span class="string">    ServerAliveInterval  10</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h1 id="config"><a href="#config" class="headerlink" title="config"></a>config</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ„æ€æ˜¯ æäº¤æ—¶ CRLF è½¬ LF</span></span><br><span class="line">git config --global core.autocrlf input</span><br><span class="line">git config --global http.sslVerify <span class="literal">false</span></span><br><span class="line">git config --global user.name <span class="string">&quot;user&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;email&quot;</span></span><br><span class="line">git config --global help.format man</span><br></pre></td></tr></table></figure>

<h1 id="key"><a href="#key" class="headerlink" title="key"></a>key</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">&quot;email&quot;</span> -b 4096</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>cheatbook</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨ python å¤„ç† excel</title>
    <url>/posts/22037f37.html</url>
    <content><![CDATA[<p>æœ¬æ–‡æ—¨åœ¨è®°å½•å¯¹excel å¸¸ç”¨æ“ä½œæ–¹å¼</p>
<a id="more"></a>

<h2 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h2><table>
<thead>
<tr>
<th>åŒ…</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td>xlrd</td>
<td>è¯»å–</td>
</tr>
<tr>
<td>xlwt</td>
<td>å†™å…¥</td>
</tr>
<tr>
<td>xlutils</td>
<td>é…åˆxlrdåšç¼–è¾‘</td>
</tr>
</tbody></table>
<h2 id="åˆ›å»ºexcel"><a href="#åˆ›å»ºexcel" class="headerlink" title="åˆ›å»ºexcel"></a>åˆ›å»ºexcel</h2><p>æœ€ç®€å•çš„ä¾‹å­å°±æ˜¯åˆ›å»ºä¸€ä¸ªsheeté¡µçš„æ–‡æ¡£</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> xlwt</span><br><span class="line"></span><br><span class="line">wb = xlwt.Workbook(encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">sheet = wb.add_sheet(<span class="string">&quot;sheet1&quot;</span>)</span><br><span class="line">wb.save(<span class="string">&quot;excel.xls&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="cell-æ“ä½œ"><a href="#cell-æ“ä½œ" class="headerlink" title="cell æ“ä½œ"></a>cell æ“ä½œ</h3><p>æ¯ä¸ªsheet éƒ½æ˜¯ä¸€ä¸ªäºŒç»´è¡¨ï¼Œé€šè¿‡ (x,y) è¿™æ ·çš„ç´¢å¼•å¯¹å•å…ƒæ ¼ï¼ˆcellï¼‰è¿›è¡Œæ“ä½œ</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å­—ç¬¦</span></span><br><span class="line">sheet.write(<span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;string&quot;</span>)</span><br><span class="line"><span class="comment"># æ•°å€¼</span></span><br><span class="line">sheet.write(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1024</span>)</span><br><span class="line"><span class="comment"># å¸ƒå°”</span></span><br><span class="line">sheet.write(<span class="number">0</span>, <span class="number">3</span>, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¶é—´/æ—¥æœŸ</span></span><br><span class="line">selfFormat = xlwt.XFStyle()</span><br><span class="line">selfFormat.num_format_str = <span class="string">&#x27;yyyy-mm-dd hh:mm:ss&#x27;</span></span><br><span class="line">sheet.write(<span class="number">0</span>, <span class="number">4</span>, datetime.datetime.now(), selfFormat)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åœ¨excelä¸­æ—¥æœŸã€æ—¶é—´æ˜¯ä»¥æµ®ç‚¹æ•°å­˜å‚¨çš„ï¼Œ<code>1 = 1900/1/1 0:00:00</code> ï¼Œå¹¶ä¸”æ¯ä¸€å¤©+1ï¼Œæ—¶é—´æŠ˜ç®—åˆ°å°æ•°</p>
</blockquote>
<h3 id="è®¾ç½®å•å…ƒæ ¼æ ·å¼"><a href="#è®¾ç½®å•å…ƒæ ¼æ ·å¼" class="headerlink" title="è®¾ç½®å•å…ƒæ ¼æ ·å¼"></a>è®¾ç½®å•å…ƒæ ¼æ ·å¼</h3><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå­—ä½“</span></span><br><span class="line">font = xlwt.Font()</span><br><span class="line">font.name = <span class="string">&quot;Arial&quot;</span></span><br><span class="line">font.bold = <span class="literal">True</span></span><br><span class="line">font.color_index = <span class="number">4</span></span><br><span class="line"><span class="comment"># font.height =</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå¯¹é½æ–¹å¼</span></span><br><span class="line">align = xlwt.Alignment()</span><br><span class="line">align.horz = xlwt.Alignment.HORZ_CENTER</span><br><span class="line">align.vert = xlwt.Alignment.VERT_CENTER</span><br><span class="line"></span><br><span class="line">style = xlwt.XFStyle()</span><br><span class="line">style.font = font</span><br><span class="line">style.alignment = align</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®åˆå¹¶</span></span><br><span class="line"><span class="comment"># å‚æ•°ï¼šèµ·å§‹è¡Œ,ç»“æŸè¡Œ,èµ·å§‹åˆ—,ç»“æŸåˆ—</span></span><br><span class="line">sheet.write_merge(<span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;åˆå¹¶å•å…ƒæ ¼&quot;</span>, style)</span><br></pre></td></tr></table></figure>

<h2 id="è¯»å–excel"><a href="#è¯»å–excel" class="headerlink" title="è¯»å–excel"></a>è¯»å–excel</h2><p>è¯»å–éœ€è¦ä½¿ç”¨ xlrd ï¼Œä¸èƒ½å¯¹å†…å®¹è¿›è¡Œä¿®æ”¹</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> xlrd</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å¼€xlsæ–‡ä»¶</span></span><br><span class="line">wb = xlrd.open_workbook(<span class="string">&quot;excel.xls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–sheet å¯ä»¥é€šè¿‡index æˆ–è€…name è¿›è¡Œç´¢å¼•</span></span><br><span class="line">sheet_names = wb.sheet_names()</span><br><span class="line">sheet = wb.sheet_by_index(<span class="number">0</span>)</span><br><span class="line">sheet = wb.sheet_by_name(<span class="string">u&#x27;Sheet1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è¦æ˜¯å¤„ç†å…¨éƒ¨è¡¨æ ¼çš„åŒ–å¯ä»¥ç›´æ¥éå†</span></span><br><span class="line">sheets = wb.sheets()</span><br><span class="line"><span class="keyword">for</span> sheet <span class="keyword">in</span> sheets:</span><br><span class="line">    <span class="comment"># è·å–æ€»è¡Œåˆ—æ•°</span></span><br><span class="line">    print(<span class="string">&quot;Sheet: %8s Rows: %2s Cols: %2s&quot;</span> % (sheet.name, sheet.nrows, sheet.ncols))</span><br><span class="line">    <span class="comment"># è·å–ç¬¬0è¡Œçš„å‰10åˆ—</span></span><br><span class="line">    sheet.row_values(<span class="number">0</span>)[:<span class="number">10</span>]</span><br><span class="line">    <span class="comment"># è·å–ä¸€åˆ—</span></span><br><span class="line">    sheet.col_values(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–å•å…ƒæ ¼</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(sheet.nrows):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(sheet.ncols):</span><br><span class="line">            <span class="comment"># åˆ¤æ–­å•å…ƒæ ¼ç±»å‹</span></span><br><span class="line">            <span class="keyword">if</span> sheet.cell_type(i, j) == xlrd.XL_CELL_TEXT:</span><br><span class="line">                print(<span class="string">&quot;Type: TEXT Value: %s&quot;</span> % sheet.cell(i, j).value)</span><br><span class="line">            <span class="keyword">if</span> sheet.cell_type(i, j) == xlrd.XL_CELL_BOOLEAN:</span><br><span class="line">                print(<span class="string">&quot;Type: BOOLEAN Value: %r&quot;</span> % sheet.cell(i, j).value)</span><br><span class="line">            <span class="keyword">if</span> sheet.cell_type(i, j) == xlrd.XL_CELL_NUMBER:</span><br><span class="line">                print(<span class="string">&quot;Type: NUMBER Value: %f&quot;</span> % sheet.cell(i, j).value)</span><br><span class="line">            <span class="keyword">if</span> sheet.cell_type(i, j) == xlrd.XL_CELL_DATE:</span><br><span class="line">                <span class="comment"># æ—¶é—´ç±»å‹å¤„ç†éœ€è¦ç¡®å®šexcel èµ·å§‹æ—¶é—´ï¼Œåœ¨è¿™é‡Œæ˜¯ 1900</span></span><br><span class="line">                <span class="comment"># xldate_as_datetime : 0: 1900-based, 1: 1904-based.</span></span><br><span class="line">                print(<span class="string">&quot;Type: DATE Value: %r&quot;</span> % xlrd.xldate.xldate_as_datetime(sheet.cell(i, j).value, <span class="number">0</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ç¼–è¾‘excel"><a href="#ç¼–è¾‘excel" class="headerlink" title="ç¼–è¾‘excel"></a>ç¼–è¾‘excel</h2><p>éœ€è¦å†åŠ  xlutils åŒ…</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> xlrd</span><br><span class="line"><span class="keyword">from</span> xlutils.copy <span class="keyword">import</span> copy</span><br><span class="line">wb = copy(xlrd.open_workbook(<span class="string">&quot;excel.xls&quot;</span>))</span><br><span class="line">sheet = wb.get_sheet(<span class="number">0</span>)</span><br><span class="line">sheet.set_name(<span class="string">&quot;copyed_%s&quot;</span> % sheet.get_name())</span><br><span class="line">wb.add_sheet(<span class="string">&quot;sheet2&quot;</span>)</span><br><span class="line">wb.save(<span class="string">&#x27;new_excel.xls&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>copy æ–¹æ³•åªä¼šæ‹·è´æ•°æ®ï¼Œæ‰€æœ‰æ ·å¼éƒ½ä¼šä¸¢å¤±</p>
</blockquote>
]]></content>
      <categories>
        <category>cheatbook</category>
      </categories>
      <tags>
        <tag>excel</tag>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>Homebrew å®‰è£…ç®€ä»‹</title>
    <url>/posts/c2f072ca.html</url>
    <content><![CDATA[<p>å®˜ç½‘ <a href="http://brew.sh/index_zh-cn.html">http://brew.sh/index_zh-cn.html</a></p>
<a id="more"></a>

<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Homebrew: è½¯ä»¶åŒ…ç®¡ç†<br>Homebrew-Core: æ ¸å¿ƒè½¯ä»¶ä»“åº“<br>Homebrew-Cask: macOS åº”ç”¨å’Œå¤§å‹äºŒè¿›åˆ¶æ–‡ä»¶<br>Homebrew-Bottles: é¢„ç¼–è¯‘äºŒè¿›åˆ¶è½¯ä»¶åŒ…</p>
<ul>
<li>homebrew/homebrew-core</li>
<li>homebrew/homebrew-dupes</li>
<li>homebrew/homebrew-php</li>
<li>homebrew/homebrew-science</li>
<li>homebrew/homebrew-nginx</li>
<li>homebrew/homebrew-apache</li>
<li>homebrew/homebrew-portable</li>
</ul>
<h2 id="å®‰è£…Homebrew"><a href="#å®‰è£…Homebrew" class="headerlink" title="å®‰è£…Homebrew"></a>å®‰è£…Homebrew</h2><p>homebrewä¸»è¦åˆ†ä¸¤éƒ¨åˆ†ï¼šgit repoï¼ˆä½äºGitHubï¼‰å’ŒäºŒè¿›åˆ¶bottlesï¼ˆä½äºbintrayï¼‰<br>ç”±äºä½ æ‡‚çš„å®‰è£…ã€æ›´æ–°ä¸€ç›´å¾ˆæ…¢ï¼Œæä¾›ä¸¤ç§æ–¹æ³•ï¼Œæˆ‘æ›´å–œæ¬¢ proxyï¼Œè¿™ç§é…ç½®æ›´ä¸ºæ–¹ä¾¿ï½</p>
<h3 id="proxy"><a href="#proxy" class="headerlink" title="proxy"></a>proxy</h3><p>proxy æ–¹æ³•å®‰è£…æ¯”è¾ƒæ–¹ä¾¿ï¼Œåœ¨æ‹‰å–ä»“åº“æ—¶è®¾ç½®proxyï¼Œä¼šæ˜¾è‘—æé«˜é€Ÿåº¦</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git config --global https.proxy http://127.0.0.1:1080</span><br><span class="line">git config --global https.proxy https://127.0.0.1:1080</span><br><span class="line">/usr/bin/ruby -e <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>&quot;</span>`</span><br></pre></td></tr></table></figure>

<h3 id="ä¿®æ”¹å®‰è£…è„šæœ¬"><a href="#ä¿®æ”¹å®‰è£…è„šæœ¬" class="headerlink" title="ä¿®æ”¹å®‰è£…è„šæœ¬"></a>ä¿®æ”¹å®‰è£…è„šæœ¬</h3><p>ä¿®æ”¹è„šæœ¬ä¸»è¦å°†githubçš„æºæ¢æˆé•œåƒçš„åœ°å€ï¼Œæ–¹ä¾¿æ— proxyçš„ç”¨æˆ·</p>
<p>install ä¸ºè‡ªä¿®æ”¹åçš„å†…å®¹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">/usr/bin/ruby -e <span class="string">&quot;<span class="subst">$(curl -fsSL https://gist.githubusercontent.com/l1b0k/329b70a22a469a5f73d6a292005ef9da/raw/b3318d9568229f07407b6cb84ba24fecd75785b5/install)</span>&quot;</span>`</span><br></pre></td></tr></table></figure>

<p>ğŸ‘‡æ˜¯å…·ä½“åˆ†æè¿‡ç¨‹</p>
<hr>
<p>å°†<a href="%60https://raw.githubusercontent.com/Homebrew/install/master/install%60">è„šæœ¬</a>ä¸‹è½½åˆ°æœ¬åœ°ï¼Œå¹¶ä¸”ç¼–è¾‘ã€ä¿å­˜</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">HOMEBREW_PREFIX = &quot;/usr/local&quot;.freeze</span><br><span class="line">HOMEBREW_REPOSITORY = &quot;/usr/local/Homebrew&quot;.freeze</span><br><span class="line">HOMEBREW_CACHE = &quot;#&#123;ENV[&quot;HOME&quot;]&#125;/Library/Caches/Homebrew&quot;.freeze</span><br><span class="line">HOMEBREW_OLD_CACHE = &quot;/Library/Caches/Homebrew&quot;.freeze</span><br><span class="line"><span class="deletion">- BREW_REPO = &quot;https://github.com/Homebrew/brew&quot;.freeze</span></span><br><span class="line"><span class="addition">+ BREW_REPO = &quot;https://mirrors.ustc.edu.cn/brew.git&quot;.freeze</span></span><br><span class="line">CORE_TAP_REPO = &quot;https://github.com/Homebrew/homebrew-core&quot;.freeze</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>âš ï¸ï¼<code>CORE_TAP_REPO</code> åœ¨è¿™é‡Œä¿®æ”¹æ˜¯æ— æ•ˆçš„ï¼ˆå·²ç»æœ‰gitçš„ç”¨æˆ·ï¼Œè¿™ä¸ªä»£ç é€»è¾‘èµ°ä¸åˆ°ã€‚ã€‚ï¼‰<br>åœ¨å®‰è£…è„šæœ¬å¤§çº¦311 è¡Œï¼Œä¼šè°ƒç”¨updateæŒ‡ä»¤ï¼Œè°ƒç”¨æ—¶ä¼šåˆå§‹åŒ–<code>/usr/local/Homebrew/Library/Tap</code>ï¼Œè¿™æ—¶brewå°±ä¼šè‡ªåŠ¨æ›´æ–°<code>homebrew-core</code>ï¼Œå¯¼è‡´ç›´æ¥è¿æ¥githubå»æ›´æ–°â€¦</p>
<p>å¤„ç†åŠæ³•ä¸ºä¸»åŠ¨è®¾ç½®ä»“åº“åœ°å€ï¼š</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">    system git, &quot;reset&quot;, &quot;--hard&quot;, &quot;origin/master&quot;</span><br><span class="line"></span><br><span class="line">    system &quot;ln&quot;, &quot;-sf&quot;, &quot;#&#123;HOMEBREW_REPOSITORY&#125;/bin/brew&quot;, &quot;#&#123;HOMEBREW_PREFIX&#125;/bin/brew&quot;</span><br><span class="line"></span><br><span class="line"><span class="addition">+ 	core_tap = &quot;#&#123;HOMEBREW_PREFIX&#125;/Homebrew/Library/Taps/homebrew/homebrew-core&quot;</span></span><br><span class="line"><span class="addition">+ 	system &quot;/bin/mkdir&quot;, &quot;-p&quot;, core_tap</span></span><br><span class="line"><span class="addition">+ 	</span></span><br><span class="line"><span class="addition">+ 	Dir.chdir core_tap do</span></span><br><span class="line"><span class="addition">+ 		system git, &quot;init&quot;, &quot;-q&quot;</span></span><br><span class="line"><span class="addition">+ 		system git, &quot;config&quot;, &quot;remote.origin.url&quot;, + &quot;https://mirrors.ustc.edu.cn/homebrew-core.git&quot;</span></span><br><span class="line"><span class="addition">+ 	    system git, &quot;config&quot;, &quot;remote.origin.fetch&quot;, &quot;+refs/heads/*:refs/remotes/origin/*&quot;</span></span><br><span class="line"><span class="addition">+ 	    system git, &quot;config&quot;, &quot;core.autocrlf&quot;, &quot;false&quot;</span></span><br><span class="line"><span class="addition">+ 	    args = git, &quot;fetch&quot;, &quot;origin&quot;, &quot;master:refs/remotes/origin/master&quot;,</span></span><br><span class="line"><span class="addition">+            &quot;--tags&quot;, &quot;--force&quot;</span></span><br><span class="line"><span class="addition">+     	system(*args)</span></span><br><span class="line"><span class="addition">+ </span></span><br><span class="line"><span class="addition">+     	system git, &quot;reset&quot;, &quot;--hard&quot;, &quot;origin/master&quot;</span></span><br><span class="line"><span class="addition">+ 	end</span></span><br><span class="line">	</span><br><span class="line">    system &quot;#&#123;HOMEBREW_PREFIX&#125;/bin/brew&quot;, &quot;update&quot;, &quot;--force&quot;</span><br></pre></td></tr></table></figure>


<p>ç„¶åæ‰§è¡Œå®‰è£…ï¼ŒæœŸé—´è¦è¾“å…¥è´¦æˆ·å¯†ç ï¼Œç»è¿‡å‡ åˆ†é’Ÿå°±å®Œæˆå®‰è£…</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">âœ  Downloads /usr/bin/ruby install</span><br><span class="line">==&gt; This script will install:</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/brew</span><br><span class="line">/usr/<span class="built_in">local</span>/share/doc/homebrew</span><br><span class="line">/usr/<span class="built_in">local</span>/share/man/man1/brew.1</span><br><span class="line">/usr/<span class="built_in">local</span>/share/zsh/site-functions/_brew</span><br><span class="line">/usr/<span class="built_in">local</span>/etc/bash_completion.d/brew</span><br><span class="line">/usr/<span class="built_in">local</span>/Homebrew</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">==&gt; Next steps:</span><br><span class="line">- Run `brew <span class="built_in">help</span>` to get started</span><br><span class="line">- Further documentation: </span><br><span class="line">    https://docs.brew.sh</span><br><span class="line">âœ  Downloads </span><br></pre></td></tr></table></figure>


<h3 id="æ¢æº"><a href="#æ¢æº" class="headerlink" title="æ¢æº"></a>æ¢æº</h3><p>æ— è®ºğŸ‘†å“ªç§å®‰è£…æ–¹å¼éƒ½å¯ä»¥å†æ‰§è¡Œä¸‹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ›¿æ¢brew</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="subst">$(brew --repo)</span>&quot;</span></span><br><span class="line">git remote set-url origin https://mirrors.ustc.edu.cn/brew.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢homebrew-core</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="subst">$(brew --repo)</span>/Library/Taps/homebrew/homebrew-core&quot;</span></span><br><span class="line">git remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢bottles</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br></pre></td></tr></table></figure>


<blockquote>
<p>ä¸Šé¢ä½¿ç”¨äº†zshï¼Œbashè¯·æŠŠ<code>~/.zshrc</code>æ”¹ä¸º <code>~/.bash_profile</code></p>
</blockquote>
<h3 id="æ¢å¤æº"><a href="#æ¢å¤æº" class="headerlink" title="æ¢å¤æº"></a>æ¢å¤æº</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é‡ç½®brew</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="subst">$(brew --repo)</span>&quot;</span></span><br><span class="line">git remote set-url origin https://github.com/Homebrew/brew.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡ç½®homebrew-core</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="subst">$(brew --repo)</span>/Library/Taps/homebrew/homebrew-core&quot;</span></span><br><span class="line">git remote set-url origin https://github.com/Homebrew/homebrew-core.git</span><br></pre></td></tr></table></figure>

<h2 id="brew-å¸¸ç”¨æŒ‡ä»¤"><a href="#brew-å¸¸ç”¨æŒ‡ä»¤" class="headerlink" title="brew å¸¸ç”¨æŒ‡ä»¤"></a>brew å¸¸ç”¨æŒ‡ä»¤</h2><p>âš ï¸ä½¿ç”¨å‰é¡ºæ‰‹å…³é—­åˆ†æè·Ÿè¸ª<br><code>brew analytics off</code></p>
<p>æ›´æ–°brewè‡ªèº«<br><code>brew update</code></p>
<p>åˆ—å‡ºè¿‡æ—¶çš„è½¯ä»¶åŒ…ï¼ˆå·²å®‰è£…ä½†ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼‰<br><code>brew outdated</code></p>
<p>æ›´æ–°è¿‡æ—¶çš„è½¯ä»¶åŒ…ï¼ˆä¸è·ŸåŒ…åå°±æ˜¯æ›´æ–°æ‰€æœ‰åŒ…ï¼‰<br><code>brew upgrade package_name</code></p>
<p>éªŒè¯brewæ˜¯å¦å®‰è£…æˆåŠŸï¼ˆä¹Ÿå¯ä»¥ç”¨æ¥æ£€æŸ¥æ— æ•ˆçš„åŒ…å’Œä¾èµ–å…³ç³»æœ‰é—®é¢˜çš„åŒ…ï¼‰<br><code>brew doctor</code></p>
<p>æŸ¥çœ‹è½¯ä»¶åŒ…ä¿¡æ¯<br><code>brew info package_name</code></p>
<p>æŸ¥æ‰¾è½¯ä»¶åŒ…<br><code>brew search package_name</code></p>
<p>å®‰è£…è½¯ä»¶åŒ…<br><code>brew install package_name</code></p>
<p>å¸è½½è½¯ä»¶<br><code>brew uninstall package_name</code></p>
<p>åˆ—å‡ºå·²å®‰è£…çš„è½¯ä»¶åŒ…<br><code>brew list</code></p>
<p>åˆ—å‡ºå®‰è£…åŒ…çš„å†…å®¹<br><code>brew list package_name</code></p>
<p>åˆ—å‡ºè½¯ä»¶åŒ…çš„ä¾èµ–å…³ç³»<br><code>brew deps package_name</code></p>
<p>åˆ—å‡ºbrewå¸¸ç”¨å‘½ä»¤<br><code>brew help</code></p>
<p>å¸è½½é™¤go ä¹‹å¤–çš„åŒ…<br><code>ls /usr/local/Cellar/ |grep -v go| xargs brew uninstall --ignore-dependencies</code></p>
<p>æ¸…ç†è¿‡æ—¶åŒ…å’Œç¼“å­˜<br><code>brew cleanup</code></p>
<h2 id="10-12-æƒé™ä¿®å¤-Deprecated"><a href="#10-12-æƒé™ä¿®å¤-Deprecated" class="headerlink" title="10.12 æƒé™ä¿®å¤(@Deprecated)"></a>10.12 æƒé™ä¿®å¤(@Deprecated)</h2><p>å‡çº§ 10.12 Sierra ä¹‹åè¿è¡Œ <code>brew update</code>ä¼šæŠ¥ <code>/usr/local</code> æ— æƒå†™å…¥<br>10.12 ä¹‹å‰ brew ä½¿ç”¨ /usr/local ä½œä¸ºä¸»ç›®å½•ï¼Œç›®å½•æ‰€æœ‰è€…æ˜¯ user<br>æ›´æ–°10.12ä¹‹å <code>/usr/local</code> è¿™ä¸ªç›®å½•æ‰€æœ‰è€…å˜æˆäº† root<br>Fix:<br><code>sudo chown $(whoami):admin /usr/local</code></p>
<p>ä¹‹åå†è¿è¡Œ <code>brew update</code> å°±èƒ½æ­£å¸¸è¿è¡Œï¼ŒåŒæ—¶ Homebrew å·²ç»æä¾›å¯¹ 10.12çš„æ”¯æŒï¼Œæ›´æ–°åä¸»ç›®å½•è¿ç§»åˆ° <code>/usr/local/Homebrew</code> ï¼Œç°åœ¨å†æŠŠæƒé™æ”¹å›æ¥</p>
<p><code>sudo chown root:wheel /usr/local</code></p>
<h2 id="ä½¿ç”¨æ‰©å±•æº-caskroom"><a href="#ä½¿ç”¨æ‰©å±•æº-caskroom" class="headerlink" title="ä½¿ç”¨æ‰©å±•æº(caskroom)"></a>ä½¿ç”¨æ‰©å±•æº(caskroom)</h2><p>brew ä½¿ç”¨ tap å‘½ä»¤æ¥å¤„ç†è½¯ä»¶æº<br><code>homebrew/core</code> æ˜¯é»˜è®¤çš„æºï¼Œè£…å®Œå°±èƒ½çœ‹åˆ°</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">âœ  ~ brew tap</span><br><span class="line">homebrew/core</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/caskroom/homebrew-cask">caskroom</a> ä¼šåŒ…å«å…¶ä»–å•†ä¸šçš„è½¯ä»¶</p>
<ul>
<li>java</li>
<li>goland</li>
<li>atom</li>
<li>intellij-idea</li>
<li>google-chrome</li>
<li>mpv</li>
</ul>
<p><a href="https://github.com/caskroom/homebrew-versions">caskroom/version</a>åŒ…å«å†å²ç‰ˆæœ¬</p>
<ul>
<li>java8</li>
</ul>
<h3 id="å®‰è£…ä¸æ¢æº"><a href="#å®‰è£…ä¸æ¢æº" class="headerlink" title="å®‰è£…ä¸æ¢æº"></a>å®‰è£…ä¸æ¢æº</h3><p>é€šè¿‡<code>brew tap caskroom/cask</code> å°±å¯ä»¥æ·»åŠ </p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">âœ  ~ brew tap caskroom/cask</span><br><span class="line">==&gt; Tapping caskroom/cask</span><br><span class="line">Cloning into <span class="string">&#x27;/usr/local/Homebrew/Library/Taps/caskroom/homebrew-cask&#x27;</span>...</span><br><span class="line">...</span><br><span class="line">âœ  ~ brew tap</span><br><span class="line">caskroom/cask</span><br><span class="line">homebrew/core</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œtapæ—¶ï¼Œå°±ä¼šæ‹‰å–ä»“åº“ï¼Œå¦‚æœå«Œæ…¢å¯ä»¥æ‰‹åŠ¨åˆ›å»ºè·¯å¾„ï¼Œé…ç½®é•œåƒä»“åº“ï¼ˆè¿‡ç¨‹ç•¥ï¼‰</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ›¿æ¢ homebrew-cask</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="subst">$(brew --repo)</span>&quot;</span>/Library/Taps/caskroom/homebrew-cask</span><br><span class="line">git remote set-url origin https://mirrors.ustc.edu.cn/homebrew-cask.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¢å¤ homebrew-cask</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="subst">$(brew --repo)</span>&quot;</span>/Library/Taps/caskroom/homebrew-cask</span><br><span class="line">git remote set-url origin https://github.com/caskroom/homebrew-cask.git</span><br></pre></td></tr></table></figure>

<h3 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h3><p><code>brew cask install goland</code></p>
<p><code>brew cask uninstall goland</code></p>
]]></content>
      <categories>
        <category>cheatbook</category>
      </categories>
      <tags>
        <tag>homebrew</tag>
        <tag>mac</tag>
      </tags>
  </entry>
  <entry>
    <title>python</title>
    <url>/posts/a4d4b8b8.html</url>
    <content><![CDATA[<h1 id="python"><a href="#python" class="headerlink" title="python"></a>python</h1><h2 id="pip-æº"><a href="#pip-æº" class="headerlink" title="pip æº"></a>pip æº</h2><p>linux </p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir -p ~/.pip</span><br><span class="line">tee ~/.pip/pip.conf&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[global]</span></span><br><span class="line"><span class="string">index-url=https://mirrors.aliyun.com/pypi/simple/</span></span><br><span class="line"><span class="string">trusted-host=mirrors.aliyun.com</span></span><br><span class="line"><span class="string">[install]</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>windows</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir -p ~/pip</span><br><span class="line">tee ~/pip/pip.ini&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[global]</span></span><br><span class="line"><span class="string">index-url=https://mirrors.aliyun.com/pypi/simple/</span></span><br><span class="line"><span class="string">trusted-host=mirrors.aliyun.com</span></span><br><span class="line"><span class="string">[install]</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>cheatbook</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>tensorflow ç¯å¢ƒæ­å»º</title>
    <url>/posts/644beb87.html</url>
    <content><![CDATA[<p>æœ¬æ–‡è®°å½•äº†å‚ç…§<a href="https://www.tensorflow.org/install/install_windows">å®˜æ–¹æ–‡æ¡£</a>ï¼Œåœ¨windowsä¸Šå®‰è£…tensorflowï¼Œå¹¶ä¸”å¼€å¯gpuåŠ é€Ÿ</p>
<h1 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h1><p>Windows10<br>GTX 1070</p>
<a id="more"></a>
<h2 id="å®‰è£…åå„ç»„ä»¶ç‰ˆæœ¬"><a href="#å®‰è£…åå„ç»„ä»¶ç‰ˆæœ¬" class="headerlink" title="å®‰è£…åå„ç»„ä»¶ç‰ˆæœ¬"></a>å®‰è£…åå„ç»„ä»¶ç‰ˆæœ¬</h2><p>Python 3.6.4<br>tensorflow 1.5.0<br>CUDA Toolkit 9.0<br>cuDNN v7.0.5 </p>
<h1 id="å®‰è£…-Anaconda"><a href="#å®‰è£…-Anaconda" class="headerlink" title="å®‰è£… Anaconda"></a>å®‰è£… Anaconda</h1><p><a href="https://www.continuum.io/downloads">https://www.continuum.io/downloads</a><br>é€‰æ‹©Python 3.6 çš„ç‰ˆæœ¬ï¼Œä¸‹è½½åé»˜è®¤é…ç½®å®‰è£…</p>
<blockquote>
<p>å®‰è£…å®Œæˆå¯ä»¥æ³¨é”€ä¸‹ï¼Œä½¿å¾—ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ</p>
</blockquote>
<p>##åˆ›å»ºvenv</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">conda create -n tensorflow pip python=3.6</span><br></pre></td></tr></table></figure>

<h2 id="æ¿€æ´»venv-amp-å®‰è£…"><a href="#æ¿€æ´»venv-amp-å®‰è£…" class="headerlink" title="æ¿€æ´»venv &amp; å®‰è£…"></a>æ¿€æ´»venv &amp; å®‰è£…</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">activate tensorflow</span><br><span class="line">pip install --ignore-installed --upgrade tensorflow-gpu</span><br></pre></td></tr></table></figure>

<p>å®‰è£…å®Œæˆåï¼Œå¯ä»¥çœ‹ä¸‹å½“å‰tfçš„ç‰ˆæœ¬</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">(tensorflow) D:\&gt;pip list</span><br><span class="line"></span><br><span class="line">tensorflow-gpu (1.5.0)</span><br><span class="line">tensorflow-tensorboard (1.5.1)</span><br></pre></td></tr></table></figure>

<h2 id="å®‰è£…cuda-amp-cuDNN"><a href="#å®‰è£…cuda-amp-cuDNN" class="headerlink" title="å®‰è£…cuda &amp; cuDNN"></a>å®‰è£…cuda &amp; cuDNN</h2><p>tf 1.5 ç‰ˆæœ¬æ”¯æŒçš„cuda ç‰ˆæœ¬ä¸º 9.0 ï¼ˆ9.1æ˜¯ä¸è¡Œçš„ï¼‰ï¼ŒcuDNN ç‰ˆæœ¬ä¸º7 ï¼ˆä¸æ˜¯å®˜æ–¹æ–‡æ¡£é‡Œçš„6)</p>
<h3 id="CUDA"><a href="#CUDA" class="headerlink" title="CUDA"></a>CUDA</h3><p><code>https://developer.nvidia.com/cuda-90-download-archive</code></p>
<p>ä¸‹è½½åä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®å®‰è£…å³å¯ã€‚</p>
<h3 id="cuDNN"><a href="#cuDNN" class="headerlink" title="cuDNN"></a>cuDNN</h3><p>ä¸‹è½½éœ€è¦å…ˆæ³¨å†Œ<br><code>https://developer.nvidia.com/rdp/cudnn-download</code></p>
<p>é€‰æ‹©<code>Download cuDNN v7.0.5 (Dec 5, 2017), for CUDA 9.0</code><br>ä¸‹è½½<br>cudnn-9.0-windows10-x64-v7.zip</p>
<p>ä¸‹è½½åæ‰¾ä¸€ä¸ªè·¯å¾„è§£å‹ï¼Œå°† <code>bin</code>æ–‡ä»¶è·¯å¾„é…ç½®åˆ°ç³»ç»Ÿ<code>PATH</code>é‡Œé¢(é…ç½®ç¯å¢ƒå˜é‡)</p>
<h1 id="æ£€æŸ¥"><a href="#æ£€æŸ¥" class="headerlink" title="æ£€æŸ¥"></a>æ£€æŸ¥</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å…ˆæ¿€æ´»venv</span></span><br><span class="line">C:\Users\u&gt;activate tensorflow</span><br><span class="line">(tensorflow) C:\Users\u&gt;python</span><br><span class="line">Python 3.6.4 |Anaconda, Inc.| (default, Jan 16 2018, 10:22:32) [MSC v.1900 64 bit (AMD64)] on win32</span><br><span class="line">Type <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> or <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; import tensorflow as tf</span><br><span class="line">&gt;&gt;&gt; hello = tf.constant(<span class="string">&#x27;Hello, TensorFlow!&#x27;</span>)</span><br><span class="line">&gt;&gt;&gt; sess = tf.Session()</span><br><span class="line">2018-02-17 13:29:11.026439: I C:\tf_jenkins\workspace\rel-win\M\windows-gpu\PY\36\tensorflow\core\platform\cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX AVX2</span><br><span class="line">2018-02-17 13:29:11.322431: I C:\tf_jenkins\workspace\rel-win\M\windows-gpu\PY\36\tensorflow\core\common_runtime\gpu\gpu_device.cc:1105] Found device 0 with properties:</span><br><span class="line">name: GeForce GTX 1070 major: 6 minor: 1 memoryClockRate(GHz): 1.7845</span><br><span class="line">pciBusID: 0000:01:00.0</span><br><span class="line">totalMemory: 8.00GiB freeMemory: 6.63GiB</span><br><span class="line">2018-02-17 13:29:11.326018: I C:\tf_jenkins\workspace\rel-win\M\windows-gpu\PY\36\tensorflow\core\common_runtime\gpu\gpu_device.cc:1195] Creating TensorFlow device (/device:GPU:0) -&gt; (device: 0, name: GeForce GTX 1070, pci bus id: 0000:01:00.0, compute capability: 6.1)</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">print</span>(sess.run(hello))</span><br><span class="line">b<span class="string">&#x27;Hello, TensorFlow!&#x27;</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤å®‰è£…å®Œæˆ~ To be continued.</p>
]]></content>
      <categories>
        <category>cheatbook</category>
      </categories>
      <tags>
        <tag>tensorflow</tag>
        <tag>tf</tag>
      </tags>
  </entry>
  <entry>
    <title>golang ä¸­ error å¤„ç†</title>
    <url>/posts/dc0f73fa.html</url>
    <content><![CDATA[<h2 id="åˆ›å»ºerror"><a href="#åˆ›å»ºerror" class="headerlink" title="åˆ›å»ºerror"></a>åˆ›å»ºerror</h2><p>é€šå¸¸åœ¨golangä¸­ç”¨ä¸‹é¢æ–¹å¼åˆ›å»ºerror</p>
<h3 id="1-fmt-Errorf"><a href="#1-fmt-Errorf" class="headerlink" title="1. fmt.Errorf"></a>1. fmt.Errorf</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">action</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;sth went wrong&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h3 id="2-errors-New"><a href="#2-errors-New" class="headerlink" title="2. errors.New"></a>2. errors.New</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">action</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> errors.New(<span class="string">&quot;sth went wrong&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-å®ç°error-æ¥å£"><a href="#3-å®ç°error-æ¥å£" class="headerlink" title="3. å®ç°error æ¥å£"></a>3. å®ç°error æ¥å£</h3><p>ä¸Šé¢ä¸¤ç§åˆ›å»ºæ–¹å¼éƒ½æ˜¯ä½¿ç”¨ errors è¿›è¡Œåˆ›å»ºçš„<br>errors å®ç°äº† error æ¥å£</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</span><br><span class="line">	Error() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰error çš„ç±»å‹ï¼Œå°±éœ€è¦å®ç° error æ¥å£</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> MyError <span class="keyword">struct</span> &#123;</span><br><span class="line">	Msg <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e MyError)</span><span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> e.Msg</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç¼–å†™çº¦å®š"><a href="#ç¼–å†™çº¦å®š" class="headerlink" title="ç¼–å†™çº¦å®š"></a>ç¼–å†™çº¦å®š</h2><p>golang çº¦å®šäº†errorä¸­çš„stringï¼šé¦–æ¯å°å†™ï¼Œç»“å°¾ä¸å¸¦æ ‡ç‚¹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">err := errors.New(<span class="string">&quot;sth went wrong&quot;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;The returned error is %s.\n&quot;</span>, err)</span><br></pre></td></tr></table></figure>

<h2 id="å¤„ç†å¼‚å¸¸"><a href="#å¤„ç†å¼‚å¸¸" class="headerlink" title="å¤„ç†å¼‚å¸¸"></a>å¤„ç†å¼‚å¸¸</h2><h3 id="æ˜¯å¦æœ‰å¼‚å¸¸"><a href="#æ˜¯å¦æœ‰å¼‚å¸¸" class="headerlink" title="æ˜¯å¦æœ‰å¼‚å¸¸"></a>æ˜¯å¦æœ‰å¼‚å¸¸</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  <span class="comment">//handle error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ˜¯å¦æœ‰ç‰¹å®šçš„å¼‚å¸¸"><a href="#æ˜¯å¦æœ‰ç‰¹å®šçš„å¼‚å¸¸" class="headerlink" title="æ˜¯å¦æœ‰ç‰¹å®šçš„å¼‚å¸¸"></a>æ˜¯å¦æœ‰ç‰¹å®šçš„å¼‚å¸¸</h3><p>é€šå¸¸åœ¨ç¨‹åºä¸­ä¼šè‡ªå®šä¹‰ä¸€ç³»åˆ—çš„å¼‚å¸¸ï¼Œæ–¹ä¾¿ç»†åŒ–å¤„ç†</p>
<h4 id="å…¨å±€å˜é‡"><a href="#å…¨å±€å˜é‡" class="headerlink" title="å…¨å±€å˜é‡"></a>å…¨å±€å˜é‡</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/os/error.go</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    ErrInvalid    = errors.New(<span class="string">&quot;invalid argument&quot;</span>)</span><br><span class="line">    ErrPermission = errors.New(<span class="string">&quot;permission denied&quot;</span>)</span><br><span class="line">    ErrExist      = errors.New(<span class="string">&quot;file already exists&quot;</span>)</span><br><span class="line">    ErrNotExist   = errors.New(<span class="string">&quot;file does not exist&quot;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœos åŒ…çš„æ–¹æ³•æœ‰å¼‚å¸¸ï¼Œå°±å¯ä»¥ç›´æ¥è¿›è¡Œæ¯”è¾ƒ</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> err == os.ErrInvalid &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å®ç°error-æ¥å£"><a href="#å®ç°error-æ¥å£" class="headerlink" title="å®ç°error æ¥å£"></a>å®ç°error æ¥å£</h4><p>å½“éœ€è¦è®°å½•æ›´å¤šå¼‚å¸¸ä¿¡æ¯æ—¶å°±è¦è‡ªå·±å®ç°error æ¥å£<br>è¿™ç§æƒ…å†µä¸‹å¯ä»¥ç”¨ç±»å‹åˆ¤æ–­æ¥åŒºåˆ†error<br>ä¸‹é¢æ˜¯ä¸ªğŸŒ°</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> MyError <span class="keyword">struct</span> &#123;</span><br><span class="line">	Msg <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e MyError)</span><span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> e.Msg</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SomeFunc ä¼šreturn error</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SomeFunc</span><span class="params">()</span> <span class="title">error</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> MyError&#123;<span class="string">&quot;bad things happen&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	err := SomeFunc()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨ switch</span></span><br><span class="line">	<span class="keyword">switch</span> err.(<span class="keyword">type</span>)&#123;</span><br><span class="line">	<span class="keyword">case</span> MyError:</span><br><span class="line">		<span class="built_in">println</span>(<span class="string">&quot;MyErr: &quot;</span> + err.Error())</span><br><span class="line">	<span class="keyword">case</span> error:</span><br><span class="line">		<span class="built_in">println</span>(<span class="string">&quot;error: &quot;</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨ assert</span></span><br><span class="line">	<span class="keyword">if</span> _, ok := err.(MyError); ok &#123;</span><br><span class="line">		<span class="built_in">println</span>(<span class="string">&quot;TypeAssert: &quot;</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>cheatbook</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title>æµ™æ±Ÿç”µä¿¡ IPTV å•çº¿å¤ç”¨</title>
    <url>/posts/8b55cd7.html</url>
    <content><![CDATA[<h2 id="åœºæ™¯"><a href="#åœºæ™¯" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h2><ul>
<li>å•çº¿å¤ç”¨</li>
<li>å®¢å…è½»åº¦ IPTV ä½¿ç”¨ï¼Œæ— å…¶ä»–è®¾å¤‡è§‚çœ‹éœ€æ±‚</li>
</ul>
<h2 id="è®¾å¤‡"><a href="#è®¾å¤‡" class="headerlink" title="è®¾å¤‡"></a>è®¾å¤‡</h2><ul>
<li>HG6201T</li>
<li>RT-AC86U</li>
</ul>
<p>HG6201T å…‰çŒ«è¶…çº§å¯†ç </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">telecomadmin</span><br><span class="line">telecomadmin90857137</span><br></pre></td></tr></table></figure>

<h2 id="å…‰çŒ«é…ç½®"><a href="#å…‰çŒ«é…ç½®" class="headerlink" title="å…‰çŒ«é…ç½®"></a>å…‰çŒ«é…ç½®</h2><p><code>ç½‘å£1</code> å•çº¿å¤ç”¨ internet + iptv</p>
<ol>
<li>å–æ¶ˆ LAN ç«¯å£ç»‘å®š</li>
</ol>
<p>internet</p>
<img src="/posts/8b55cd7/lan_internet.png" class="">

<p>iptv</p>
<img src="/posts/8b55cd7/lan_iptv.png" class="">

<ol start="2">
<li>vlan ç»‘å®š</li>
</ol>
<p>åªç»‘å®š iptv çš„ vlan åˆ°ç½‘å£1</p>
<img src="/posts/8b55cd7/vlan_bind.png" class="">

<blockquote>
<p>å…¶ä»–æ–‡ç« é‡Œè¯´çš„åŒæ—¶ç»‘å®š internetå’Œiptv çš„vlan å®é™…è¯•éªŒå¤±è´¥<br>  çœ‹èµ·æ¥åº”è¯¥æ˜¯æŒ‚ä¸¤ä¸ªä¸åŒçš„ vlan ä¸‹ï¼Œä½†æ˜¯ 86u åŒæ­¥é…ç½® VID åæ˜¯ä¸è¡Œçš„ï¼ŒåŸå› æ²¡å†åˆ†æäº†</p>
</blockquote>
<ol start="3">
<li>ç»„æ’­</li>
</ol>
<p>ç»„æ’­æ²¡æ”¹é…ç½®ï¼Œå·²ç»å¼€å¯äº† <code>IGMPSnooping</code></p>
<img src="/posts/8b55cd7/igmp.png" class="">

<h2 id="AC86U-é…ç½®"><a href="#AC86U-é…ç½®" class="headerlink" title="AC86U é…ç½®"></a>AC86U é…ç½®</h2><ol>
<li>å…‰çŒ«ç½‘å£1 è¿æ¥86u çš„wan å£</li>
<li>åœ¨ IPTV é…ç½®ä¸­ï¼Œåªé…ç½® IPTV çš„ <code>VID 43</code>ï¼Œä¸é…ç½® internet</li>
</ol>
<img src="/posts/8b55cd7/86u_iptv.png" class="">

<blockquote>
<p>86U è¿™å—åå°é…ç½®æ²¡ä»€ä¹ˆæ–‡æ¡£ï¼Œå®åœ¨æä¸æ¸…æ€ä¹ˆæ¥å…¥çš„ï¼Œä¸Šè¿°é…ç½®å­˜ç²¹è¯•å‡ºæ¥çš„ã€‚ã€‚</p>
</blockquote>
<h2 id="å®Œæˆ"><a href="#å®Œæˆ" class="headerlink" title="å®Œæˆ"></a>å®Œæˆ</h2><p>é‡å¯ä¸¤ä¸ªè®¾å¤‡å³å¯</p>
<p>ç®€å•è§‚å¯Ÿäº†ä¸‹ 86U æ²¡ä»€ä¹ˆè´Ÿè½½ï¼Œä¸€åˆ‡éƒ½å¥½</p>
]]></content>
      <categories>
        <category>home-network</category>
      </categories>
      <tags>
        <tag>iptv</tag>
      </tags>
  </entry>
  <entry>
    <title>åœ¨ K8S ä¸­ä½¿ç”¨ IP SAN è®¾å¤‡</title>
    <url>/posts/f039165f.html</url>
    <content><![CDATA[<h2 id="TOC"><a href="#TOC" class="headerlink" title="TOC"></a>TOC</h2><ul>
<li>IP SAN è®¾å¤‡é…ç½®ç®€ä»‹</li>
<li>CentOS 7 ä½¿ç”¨ iSCSI è¿æ¥è®¾å¤‡</li>
<li>K8S ä½¿ç”¨ iSCSI ä½œä¸ºpvåç«¯</li>
<li>CentOS 7 ä½¿ç”¨ NFS è¿æ¥è®¾å¤‡</li>
<li>K8S ä½¿ç”¨ NFS ä½œä¸ºpvåç«¯</li>
</ul>
<a id="more"></a>
<h2 id="æœ¯è¯­"><a href="#æœ¯è¯­" class="headerlink" title="æœ¯è¯­"></a>æœ¯è¯­</h2><table>
<thead>
<tr>
<th>ç¼©å†™</th>
<th>å®šä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td>iSCSI</td>
<td>Internet Small Computer System Interface</td>
</tr>
<tr>
<td>IQN</td>
<td>iSCSI Qualified Name</td>
</tr>
<tr>
<td>NFS</td>
<td>Network File System</td>
</tr>
</tbody></table>
<h2 id="IP-SAN-è®¾å¤‡é…ç½®ç®€ä»‹"><a href="#IP-SAN-è®¾å¤‡é…ç½®ç®€ä»‹" class="headerlink" title="IP SAN è®¾å¤‡é…ç½®ç®€ä»‹"></a>IP SAN è®¾å¤‡é…ç½®ç®€ä»‹</h2><p>IP SAN é…ç½®ç•¥<br>æœ¬æ–‡ä¸»è¦æ¢ç©¶ iSCSIã€NFSä¸¤ç§åè®®çš„ä½¿ç”¨æ–¹å¼</p>
<h3 id="k8s-å¯¹å­˜å‚¨çš„æ”¯æŒæƒ…å†µ"><a href="#k8s-å¯¹å­˜å‚¨çš„æ”¯æŒæƒ…å†µ" class="headerlink" title="k8s å¯¹å­˜å‚¨çš„æ”¯æŒæƒ…å†µ"></a>k8s å¯¹å­˜å‚¨çš„æ”¯æŒæƒ…å†µ</h3><table>
<thead>
<tr>
<th align="left">Volume Plugin</th>
<th align="center">ReadWriteOnce</th>
<th align="center">ReadOnlyMany</th>
<th align="center">ReadWriteMany</th>
</tr>
</thead>
<tbody><tr>
<td align="left">HostPath</td>
<td align="center">&#x2713;</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">iSCSI</td>
<td align="center">&#x2713;</td>
<td align="center">&#x2713;</td>
<td align="center">-</td>
</tr>
<tr>
<td align="left">NFS</td>
<td align="center">&#x2713;</td>
<td align="center">&#x2713;</td>
<td align="center">&#x2713;</td>
</tr>
</tbody></table>
<p>NFS ç›¸å¯¹æ”¯æŒæ¯”è¾ƒå¥½ç‚¹ï¼Œæ”¯æŒå¤šè¯»å¤šå†™ï¼Œæ¨èä½¿ç”¨</p>
<h2 id="CentOS-7-ä½¿ç”¨-iSCSI-è¿æ¥è®¾å¤‡"><a href="#CentOS-7-ä½¿ç”¨-iSCSI-è¿æ¥è®¾å¤‡" class="headerlink" title="CentOS 7 ä½¿ç”¨ iSCSI è¿æ¥è®¾å¤‡"></a>CentOS 7 ä½¿ç”¨ iSCSI è¿æ¥è®¾å¤‡</h2><p>é¦–å…ˆå®‰è£… iSCSI æ§åˆ¶å™¨</p>
<p><code>yum install iscsi-initiator-utils -y</code></p>
<h3 id="æœç´¢è®¾å¤‡"><a href="#æœç´¢è®¾å¤‡" class="headerlink" title="æœç´¢è®¾å¤‡"></a>æœç´¢è®¾å¤‡</h3><p>æœç´¢ä¸‹è®¾å¤‡ï¼Œæ‰¾åˆ° IQN</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master1 ~]# iscsiadm -m discoverydb -t sendtargets -p 192.168.88.100 -I default --discover</span><br><span class="line">...</span><br><span class="line">192.168.88.100:3260,1 iqn.2471-05.storos.t:27</span><br><span class="line">10.15.117.190:3260,1 iqn.2471-05.storos.t:27</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="æŒ‚è½½è®¾å¤‡"><a href="#æŒ‚è½½è®¾å¤‡" class="headerlink" title="æŒ‚è½½è®¾å¤‡"></a>æŒ‚è½½è®¾å¤‡</h3><p>é€šè¿‡<code>fdisk -l</code> çœ‹ä¸‹æŒ‚è½½å‰æƒ…å†µ</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># fdisk -l</span></span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 480.1 GB, 480103981056 bytes, 937703088 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 4096 bytes</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>çœ‹åˆ°åªæœ‰ä¸€å—ç¡¬ç›˜  <code>/dev/sda</code></p>
<p>ç„¶åæ‰§è¡ŒæŒ‚è½½æŒ‡ä»¤ï¼Œå¹¶æŸ¥çœ‹æŒ‚è½½åæƒ…å†µ</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># iscsiadm -m node -T iqn.2471-05.storos.t:27 -p 192.168.88.100 -l</span></span><br><span class="line">[root@master1 ~]<span class="comment"># fdisk -l</span></span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 480.1 GB, 480103981056 bytes, 937703088 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 10.7 GB, 10737418240 bytes, 2621440 sectors</span><br><span class="line">Units = sectors of 1 * 4096 = 4096 bytes</span><br><span class="line">Sector size (logical/physical): 4096 bytes / 4096 bytes</span><br><span class="line">I/O size (minimum/optimal): 4096 bytes / 524288 bytes</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° <code>/dev/sdb</code> å·²ç»è¢«æŒ‚è½½åˆ°æœ¬åœ°<br>éšåä½¿ç”¨å°±å’Œå…¶ä»–ç£ç›˜ä¸€æ ·ï¼Œå¯ä»¥æ ¼å¼åŒ–ã€æŒ‚è½½</p>
<h4 id="åˆ›å»ºåˆ†åŒº"><a href="#åˆ›å»ºåˆ†åŒº" class="headerlink" title="åˆ›å»ºåˆ†åŒº"></a>åˆ›å»ºåˆ†åŒº</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># fdisk /dev/sdb</span></span><br><span class="line">Welcome to fdisk (util-linux 2.23.2).</span><br><span class="line"></span><br><span class="line">Changes will remain <span class="keyword">in</span> memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write <span class="built_in">command</span>.</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table</span><br><span class="line">Building a new DOS disklabel with disk identifier 0xc26993b8.</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): p</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 10.7 GB, 10737418240 bytes, 2621440 sectors</span><br><span class="line">Units = sectors of 1 * 4096 = 4096 bytes</span><br><span class="line">Sector size (logical/physical): 4096 bytes / 4096 bytes</span><br><span class="line">I/O size (minimum/optimal): 4096 bytes / 524288 bytes</span><br><span class="line">Disk label <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: 0xc26993b8</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Partition <span class="built_in">type</span>:</span><br><span class="line">   p   primary (0 primary, 0 extended, 4 free)</span><br><span class="line">   e   extended</span><br><span class="line">Select (default p): p</span><br><span class="line">Partition number (1-4, default 1): </span><br><span class="line">First sector (256-2621439, default 256): </span><br><span class="line">Using default value 256</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (256-2621439, default 2621439): </span><br><span class="line">Using default value 2621439</span><br><span class="line">Partition 1 of <span class="built_in">type</span> Linux and of size 10 GiB is <span class="built_in">set</span></span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w</span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure>

<h4 id="æ ¼å¼åŒ–åˆ†åŒº"><a href="#æ ¼å¼åŒ–åˆ†åŒº" class="headerlink" title="æ ¼å¼åŒ–åˆ†åŒº"></a>æ ¼å¼åŒ–åˆ†åŒº</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkfs.ext4 /dev/sdb1</span><br></pre></td></tr></table></figure>

<h3 id="ä¼šè¯æŸ¥çœ‹ä¸å¸è½½"><a href="#ä¼šè¯æŸ¥çœ‹ä¸å¸è½½" class="headerlink" title="ä¼šè¯æŸ¥çœ‹ä¸å¸è½½"></a>ä¼šè¯æŸ¥çœ‹ä¸å¸è½½</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># iscsiadm -m session</span></span><br><span class="line">tcp: [1] 192.168.88.100:3260,1 iqn.2471-05.storos.t:27 (non-flash)</span><br><span class="line">[root@master1 ~]<span class="comment"># </span></span><br><span class="line">[root@master1 ~]<span class="comment"># iscsiadm -m node -T iqn.2471-05.storos.t:27 -p 192.168.88.100 -u</span></span><br><span class="line">Logging out of session [sid: 1, target: iqn.2471-05.storos.t:27, portal: 192.168.88.100,3260]</span><br><span class="line">Logout of [sid: 1, target: iqn.2471-05.storos.t:27, portal: 192.168.88.100,3260] successful.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="CHAP-authentication"><a href="#CHAP-authentication" class="headerlink" title="CHAP authentication"></a>CHAP authentication</h3><p>åœ¨IP SAN é‡Œé¢åˆ›å»ºç”¨æˆ·<code>test_chap</code> ï¼Œå¯†ç ä¸º<code>test_chap</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master1 ~]# iscsiadm -m node -T iqn.2471-05.storos.t:27 -p 192.168.88.100 -o update --name&#x3D;node.session.auth.username --value&#x3D;test_chap</span><br><span class="line">[root@master1 ~]# iscsiadm -m node -T iqn.2471-05.storos.t:27 -p 192.168.88.100 -o update --name&#x3D;node.session.auth.password --value&#x3D;test_chap</span><br><span class="line">[root@master1 ~]# iscsiadm -m node -T iqn.2471-05.storos.t:27 -p 192.168.88.100 -l</span><br><span class="line">Logging in to [iface: default, target: iqn.2471-05.storos.t:27, portal: 192.168.88.100,3260] (multiple)</span><br><span class="line">Login to [iface: default, target: iqn.2471-05.storos.t:27, portal: 192.168.88.100,3260] successful.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™é‡Œåªæè¿°åˆ›å»ºä¼šè¯çš„è®¤è¯è¿‡ç¨‹ï¼Œæœç´¢è¿‡ç¨‹æ²¡åšè®¤è¯</p>
</blockquote>
<h2 id="K8S-ä½¿ç”¨-iSCSI-ä½œä¸ºpvåç«¯"><a href="#K8S-ä½¿ç”¨-iSCSI-ä½œä¸ºpvåç«¯" class="headerlink" title="K8S ä½¿ç”¨ iSCSI ä½œä¸ºpvåç«¯"></a>K8S ä½¿ç”¨ iSCSI ä½œä¸ºpvåç«¯</h2><h3 id="åˆ›å»ºpv"><a href="#åˆ›å»ºpv" class="headerlink" title="åˆ›å»ºpv"></a>åˆ›å»ºpv</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-mysql</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test-mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">iscsi:</span></span><br><span class="line">    <span class="attr">targetPortal:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span><span class="string">:3260</span></span><br><span class="line">    <span class="attr">iqn:</span> <span class="string">iqn.2471-05.storos.t:27</span></span><br><span class="line">    <span class="attr">fsType:</span> <span class="string">ext4</span></span><br><span class="line">    <span class="attr">lun:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>lun</code> ä¸ºå®¢æˆ·ç«¯å·å·ï¼ˆåœ¨sanç®¡ç†/iSCSIç®¡ç†ç•Œé¢æŸ¥è¯¢ï¼Œä¾æ®è®¾å¤‡ä¸åŒè€Œä¸åŒï¼‰</p>
<p>ç£ç›˜ä¸Šå¦‚æœæ•°æ®æ ¼å¼ä¸å¯¹ï¼Œæ— æ³•æŒ‚è½½ï¼Œæœ€å¥½æ–°å»ºç£ç›˜ï¼Œè®© <code>K8S</code> è‡ªè¡Œå»åšåˆå§‹åŒ–</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Apr 11 13:46:58 master1 kubelet[16033]: E0411 13:46:58.912465   16033 nestedpendingoperations.go:264] Operation <span class="keyword">for</span> <span class="string">&quot;\&quot;kubernetes.io/iscsi/192.168.88.100:3260:iqn.2471-05.storos.t:27:0\&quot;&quot;</span> failed. No retries permitted until 2018-04-11 13:47:06.91242994 +0800 CST (durationBeforeRetry 8s). Error: MountVolume.WaitForAttach failed <span class="keyword">for</span> volume <span class="string">&quot;test-mysql&quot;</span> (UniqueName: <span class="string">&quot;kubernetes.io/iscsi/192.168.88.100:3260:iqn.2471-05.storos.t:27:0&quot;</span>) pod <span class="string">&quot;test-mysql-dd6df7d44-d4jkj&quot;</span> (UID: <span class="string">&quot;6b529d7b-3d4b-11e8-8ab1-0cc47ae55938&quot;</span>) : failed to mount the volume as <span class="string">&quot;ext4&quot;</span>, it already contains unknown data, probably partitions. Mount error: mount failed: <span class="built_in">exit</span> status 32</span><br></pre></td></tr></table></figure>


<h3 id="æŒ‚è½½è¿‡ç¨‹"><a href="#æŒ‚è½½è¿‡ç¨‹" class="headerlink" title="æŒ‚è½½è¿‡ç¨‹"></a>æŒ‚è½½è¿‡ç¨‹</h3><h4 id="kubelet-æŒ‚è½½è¿‡ç¨‹"><a href="#kubelet-æŒ‚è½½è¿‡ç¨‹" class="headerlink" title="kubelet æŒ‚è½½è¿‡ç¨‹"></a>kubelet æŒ‚è½½è¿‡ç¨‹</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master1 ~]# journalctl -u kubelet -f | grep iscsi</span><br><span class="line">Apr 11 14:19:35 master1 kubelet[16033]: I0411 14:19:35.194301   16033 reconciler.go:212] operationExecutor.VerifyControllerAttachedVolume started for volume &quot;test-mysql&quot; (UniqueName: &quot;kubernetes.io&#x2F;iscsi&#x2F;192.168.88.100:3260:iqn.2471-05.storos.t:27:0&quot;) pod &quot;test-mysql-dd6df7d44-lqj4j&quot; (UID: &quot;38528d0a-3d50-11e8-8ab1-0cc47ae55938&quot;)</span><br><span class="line">Apr 11 14:19:35 master1 kubelet[16033]: I0411 14:19:35.198210   16033 operation_generator.go:684] Controller attach succeeded for volume &quot;test-mysql&quot; (UniqueName: &quot;kubernetes.io&#x2F;iscsi&#x2F;192.168.88.100:3260:iqn.2471-05.storos.t:27:0&quot;) pod &quot;test-mysql-dd6df7d44-lqj4j&quot; (UID: &quot;38528d0a-3d50-11e8-8ab1-0cc47ae55938&quot;) device path: &quot;&quot;</span><br><span class="line">Apr 11 14:19:35 master1 kubelet[16033]: I0411 14:19:35.294607   16033 reconciler.go:257] operationExecutor.MountVolume started for volume &quot;test-mysql&quot; (UniqueName: &quot;kubernetes.io&#x2F;iscsi&#x2F;192.168.88.100:3260:iqn.2471-05.storos.t:27:0&quot;) pod &quot;test-mysql-dd6df7d44-lqj4j&quot; (UID: &quot;38528d0a-3d50-11e8-8ab1-0cc47ae55938&quot;)</span><br><span class="line">Apr 11 14:19:35 master1 kubelet[16033]: I0411 14:19:35.294653   16033 operation_generator.go:416] MountVolume.WaitForAttach entering for volume &quot;test-mysql&quot; (UniqueName: &quot;kubernetes.io&#x2F;iscs&#x2F;192.168.88.100:3260:iqn.2471-05.storos.t:27:0&quot;) pod &quot;test-mysql-dd6df7d44-lqj4j&quot; (UID: &quot;38528d0a-3d50-11e8-8ab1-0cc47ae55938&quot;) DevicePath &quot;&quot;</span><br><span class="line">Apr 11 14:19:35 master1 kubelet[16033]: E0411 14:19:35.314813   16033 iscsi_util.go:233] iscsi: failed to rescan session with error: iscsiadm: No session found.</span><br><span class="line">Apr 11 14:19:36 master1 kubelet[16033]: Mounting arguments: --description&#x3D;Kubernetes transient mount for &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;plugins&#x2F;kubernetes.io&#x2F;iscsi&#x2F;iface-default&#x2F;192.168.88.100:3260-iqn.2471-05.storos.t:27-lun-0 --scope -- mount -t ext4 -o defaults &#x2F;dev&#x2F;disk&#x2F;by-path&#x2F;ip-192.168.88.100:3260-iscsi-iqn.2471-05.storos.t:27-lun-0 &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;plugins&#x2F;kubernetes.io&#x2F;iscsi&#x2F;iface-default&#x2F;192.168.88.100:3260-iqn.2471-05.storos.t:27-lun-0</span><br><span class="line">Apr 11 14:19:36 master1 kubelet[16033]: I0411 14:19:36.546450   16033 mount_linux.go:404] Disk &quot;&#x2F;dev&#x2F;disk&#x2F;by-path&#x2F;ip-192.168.88.100:3260-iscsi-iqn.2471-05.storos.t:27-lun-0&quot; appears to be unformatted, attempting to format as type: &quot;ext4&quot; with options: [-F &#x2F;dev&#x2F;disk&#x2F;by-path&#x2F;ip-192.168.88.100:3260-iscsi-iqn.2471-05.storos.t:27-lun-0]</span><br><span class="line">Apr 11 14:19:38 master1 kubelet[16033]: I0411 14:19:38.003506   16033 mount_linux.go:408] Disk successfully formatted (mkfs): ext4 - &#x2F;dev&#x2F;disk&#x2F;by-path&#x2F;ip-192.168.88.100:3260-iscsi-iqn.2471-05.storos.t:27-lun-0 &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;plugins&#x2F;kubernetes.io&#x2F;iscsi&#x2F;iface-default&#x2F;192.168.88.100:3260-iqn.2471-05.storos.t:27-lun-0</span><br><span class="line">Apr 11 14:19:38 master1 kubelet[16033]: I0411 14:19:38.022322   16033 operation_generator.go:425] MountVolume.WaitForAttach succeeded for volume &quot;test-mysql&quot; (UniqueName: &quot;kubernetes.io&#x2F;iscsi&#x2F;192.168.88.100:3260:iqn.2471-05.storos.t:27:0&quot;) pod &quot;test-mysql-dd6df7d44-lqj4j&quot; (UID: &quot;38528d0a-3d50-11e8-8ab1-0cc47ae55938&quot;)</span><br><span class="line">Apr 11 14:19:38 master1 kubelet[16033]: I0411 14:19:38.022420   16033 operation_generator.go:446] MountVolume.MountDevice succeeded for volume &quot;test-mysql&quot; (UniqueName: &quot;kubernetes.io&#x2F;iscsi&#x2F;192.168.88.100:3260:iqn.2471-05.storos.t:27:0&quot;) pod &quot;test-mysql-dd6df7d44-lqj4j&quot; (UID: &quot;38528d0a-3d50-11e8-8ab1-0cc47ae55938&quot;) device mount path &quot;&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;plugins&#x2F;kubernetes.io&#x2F;iscs&#x2F;iface-default&#x2F;192.168.88.100:3260-iqn.2471-05.storos.t:27-lun-0&quot;</span><br><span class="line">Apr 11 14:19:38 master1 kubelet[16033]: I0411 14:19:38.061696   16033 operation_generator.go:484] MountVolume.SetUp succeeded for volume &quot;test-mysql&quot; (UniqueName: &quot;kubernetes.io&#x2F;iscsi&#x2F;192.168.88.100:3260:iqn.2471-05.storos.t:27:0&quot;) pod &quot;test-mysql-dd6df7d44-lqj4j&quot; (UID: &quot;38528d0a-3d50-11e8-8ab1-0cc47ae55938&quot;)</span><br><span class="line">Apr 11 14:20:21 master1 kubelet[16033]: I0411 14:20:21.347063   16033 reconciler.go:407] Reconciler sync states: could not find pod information in desired or actual states or pending operation, update it in both states: &amp;&#123;volumeName:kubernetes.io&#x2F;iscsi&#x2F;test-mysql:test-mysql:0 podName:38528d0a-3d50-11e8-8ab1-0cc47ae55938 volumeSpec:0xc422c2f760 outerVolumeSpecName:test-mysql pod:0xc42389c380 pluginIsAttachable:true volumeGidValue: devicePath: reportedInUse:false mounter:0xc420bdfc80&#125;</span><br><span class="line">Apr 11 14:20:21 master1 kubelet[16033]: I0411 14:20:21.351063   16033 reconciler.go:547] Volume: kubernetes.io&#x2F;iscsi&#x2F;test-mysql:test-mysql:0 is mounted</span><br></pre></td></tr></table></figure>

<h4 id="ä¸»æœºæŒ‚è½½ç‚¹æŸ¥çœ‹"><a href="#ä¸»æœºæŒ‚è½½ç‚¹æŸ¥çœ‹" class="headerlink" title="ä¸»æœºæŒ‚è½½ç‚¹æŸ¥çœ‹"></a>ä¸»æœºæŒ‚è½½ç‚¹æŸ¥çœ‹</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master1 ~]# df -h | grep sdb</span><br><span class="line">&#x2F;dev&#x2F;sdb        9.8G  246M  9.0G   3% &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F;38528d0a-3d50-11e8-8ab1-0cc47ae55938&#x2F;volumes&#x2F;kubernetes.io~iscsi&#x2F;test-mysql</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master1 ~]# mount |grep kub</span><br><span class="line">&#x2F;dev&#x2F;sdb on &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;plugins&#x2F;kubernetes.io&#x2F;iscsi&#x2F;iface-default&#x2F;192.168.88.100:3260-iqn.2471-05.storos.t:27-lun-0 type ext4 (rw,relatime,stripe&#x3D;128,data&#x3D;ordered)</span><br><span class="line">&#x2F;dev&#x2F;sdb on &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F;38528d0a-3d50-11e8-8ab1-0cc47ae55938&#x2F;volumes&#x2F;kubernetes.io~iscsi&#x2F;test-mysql type ext4 (rw,relatime,stripe&#x3D;128,data&#x3D;ordered)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


<h3 id="CHAP-authentication-1"><a href="#CHAP-authentication-1" class="headerlink" title="CHAP authentication"></a>CHAP authentication</h3><p>ä¿®æ”¹PV çš„é…ç½®æ–‡ä»¶</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">chap-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">&quot;kubernetes.io/iscsi-chap&quot;</span>  </span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">node.session.auth.username:</span> <span class="string">aGlrY2xvdWRfY2hhcA==</span></span><br><span class="line">  <span class="attr">node.session.auth.password:</span> <span class="string">aGlrY2xvdWRfY2hhcA==</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-mysql</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test-mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">iscsi:</span></span><br><span class="line">    <span class="attr">targetPortal:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span><span class="string">:3260</span></span><br><span class="line">    <span class="attr">iqn:</span> <span class="string">iqn.2471-05.storos.t:27</span></span><br><span class="line">    <span class="attr">fsType:</span> <span class="string">ext4</span></span><br><span class="line">    <span class="attr">lun:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">chapAuthDiscovery:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">chapAuthSession:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">secretRef:</span> </span><br><span class="line">       <span class="attr">name:</span> <span class="string">chap-secret</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>secretä¸­å…¶ä»–é…ç½®é¡¹å‚è§ <a href="https://github.com/open-iscsi/open-iscsi/blob/master/etc/iscsid.conf">Open-iSCSI</a></p>
</blockquote>
<h2 id="CentOS-7-ä½¿ç”¨-NFS-è¿æ¥è®¾å¤‡"><a href="#CentOS-7-ä½¿ç”¨-NFS-è¿æ¥è®¾å¤‡" class="headerlink" title="CentOS 7 ä½¿ç”¨ NFS è¿æ¥è®¾å¤‡"></a>CentOS 7 ä½¿ç”¨ NFS è¿æ¥è®¾å¤‡</h2><p>é¦–å…ˆå®‰è£…nfså·¥å…·</p>
<p><code>yum -y install nfs-utils</code></p>
<h3 id="æŸ¥çœ‹NASçš„æŒ‚è½½ç‚¹"><a href="#æŸ¥çœ‹NASçš„æŒ‚è½½ç‚¹" class="headerlink" title="æŸ¥çœ‹NASçš„æŒ‚è½½ç‚¹"></a>æŸ¥çœ‹NASçš„æŒ‚è½½ç‚¹</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master1 ~]# showmount -e 192.168.88.100</span><br><span class="line">Export list for 192.168.88.100:</span><br><span class="line">&#x2F;nas&#x2F;test_nfs&#x2F;test_nfs 0.0.0.0&#x2F;0.0.0.0</span><br><span class="line">&#x2F;nas&#x2F;nfs_falcon_db&#x2F;nfs1        0.0.0.0&#x2F;0.0.0.0</span><br><span class="line">&#x2F;nas&#x2F;nfs_falcon_db&#x2F;db          0.0.0.0&#x2F;0.0.0.0</span><br><span class="line">&#x2F;nas&#x2F;nfs_falcon_rtsp&#x2F;rtsp      0.0.0.0&#x2F;0.0.0.0</span><br><span class="line">&#x2F;mnt&#x2F;backup&#x2F;indexbackup        0.0.0.0&#x2F;0.0.0.0</span><br></pre></td></tr></table></figure>

<h3 id="æŒ‚è½½"><a href="#æŒ‚è½½" class="headerlink" title="æŒ‚è½½"></a>æŒ‚è½½</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir -p /root/test_nfs</span><br><span class="line">mount -t nfs 192.168.88.100:/nas/test_nfs/test_nfs /root/test_nfs</span><br></pre></td></tr></table></figure>

<h2 id="K8S-ä½¿ç”¨-NFS-ä½œä¸ºpvåç«¯"><a href="#K8S-ä½¿ç”¨-NFS-ä½œä¸ºpvåç«¯" class="headerlink" title="K8S ä½¿ç”¨ NFS ä½œä¸ºpvåç«¯"></a>K8S ä½¿ç”¨ NFS ä½œä¸ºpvåç«¯</h2><h3 id="åˆ›å»ºpv-1"><a href="#åˆ›å»ºpv-1" class="headerlink" title="åˆ›å»ºpv"></a>åˆ›å»ºpv</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-mysql</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test-mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;/nas/test_nfs/test_nfs&quot;</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼ŒMySQL æ— æ³•å¯åŠ¨ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># kubectl logs -f  mysql-test</span></span><br><span class="line">Initializing database</span><br><span class="line">2018-04-13T03:46:31.653727Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation <span class="keyword">for</span> more details).</span><br><span class="line">2018-04-13T03:46:31.695064Z 0 [ERROR] InnoDB: Unable to lock ./ibdata1 error: 37</span><br><span class="line">2018-04-13T03:46:31.695129Z 0 [ERROR] InnoDB: Operating system error number 37 <span class="keyword">in</span> a file operation.</span><br><span class="line">2018-04-13T03:46:31.695179Z 0 [ERROR] InnoDB: Error number 37 means <span class="string">&#x27;No locks available&#x27;</span></span><br><span class="line">2018-04-13T03:46:31.695194Z 0 [ERROR] InnoDB: Cannot open datafile <span class="string">&#x27;./ibdata1&#x27;</span></span><br><span class="line">2018-04-13T03:46:31.695216Z 0 [ERROR] InnoDB: Could not open or create the system tablespace. If you tried to add new data files to the system tablespace, and it failed here, you should now edit innodb_data_file_path <span class="keyword">in</span> my.cnf back to what it was, and remove the new ibdata files InnoDB created <span class="keyword">in</span> this failed attempt. InnoDB only wrote those files full of zeros, but did not yet use them <span class="keyword">in</span> any way. But be careful: <span class="keyword">do</span> not remove old data files <span class="built_in">which</span> contain your precious data!</span><br><span class="line">2018-04-13T03:46:31.695228Z 0 [ERROR] InnoDB: InnoDB Database creation was aborted with error Cannot open a file. You may need to delete the ibdata1 file before trying to start up again.</span><br><span class="line">2018-04-13T03:46:32.295901Z 0 [ERROR] Plugin <span class="string">&#x27;InnoDB&#x27;</span> init <span class="keyword">function</span> returned error.</span><br><span class="line">2018-04-13T03:46:32.295925Z 0 [ERROR] Plugin <span class="string">&#x27;InnoDB&#x27;</span> registration as a STORAGE ENGINE failed.</span><br><span class="line">2018-04-13T03:46:32.295936Z 0 [ERROR] Failed to initialize <span class="built_in">builtin</span> plugins.</span><br><span class="line">2018-04-13T03:46:32.295941Z 0 [ERROR] Aborting</span><br></pre></td></tr></table></figure>

<p>åˆ†æäº†ä¸‹å°±æ˜¯<code>.lock</code> æ–‡ä»¶ä¸èƒ½åˆ›å»ºï¼Œç„¶åå°±é€€å‡ºäº†<br>å¯¹åº”çš„BUGè®°å½•<a href="https://bugs.mysql.com/bug.php?id=71969">mysql bug</a><br>æ„æ€å°±æ˜¯è¿™ä¸ªæ˜¯å’Œä½¿ç”¨çš„NFSv3 åè®®æœ‰å…³ç³»ï¼Œæ®è¯´ NFSv4 å·²ç»è§£å†³ï¼Œä¸å¹¸çš„æ˜¯æˆ‘ä»¬è®¾å¤‡æ˜¯NFSv3åè®®çš„ï¼Œéšåæ”¹äº†ä¸‹<code>mountOptions</code>ï¼Œå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-mysql</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test-mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">   <span class="attr">mountOptions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nolock</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hard</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rw</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">proto=tcp</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">vers=3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mountvers=3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfsvers=3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rsize=524288</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">wsize=524288</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namlen=255</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.88</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;/nas/test_nfs/test_nfs&quot;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>kubernetes</tag>
        <tag>nfs</tag>
        <tag>iscsi</tag>
      </tags>
  </entry>
  <entry>
    <title>use of closed network connection</title>
    <url>/posts/e32fa4d.html</url>
    <content><![CDATA[<h2 id="é—®é¢˜ç°è±¡"><a href="#é—®é¢˜ç°è±¡" class="headerlink" title="é—®é¢˜ç°è±¡"></a>é—®é¢˜ç°è±¡</h2><p>å¯é æ€§éªŒè¯æ—¶ï¼Œå‘ç°å¤§çº¦å­˜åœ¨ 1/2000 æ¦‚ç‡å­˜åœ¨ èŠ‚ç‚¹ NotReady ï¼Œå¹¶ä¸”<strong>ä¸å¯è‡ªæ„ˆé—®é¢˜</strong><br>kubelet æŠ¥ <code>use of closed network connection</code></p>
<p>ç°è±¡</p>
<ul>
<li>èŠ‚ç‚¹NotReady</li>
<li>kubelet æ—¥å¿—å§‹ç»ˆæ‰“å° <code>use of closed network connection</code></li>
</ul>
<p>åˆæ­¥å®šä½åƒè¿æ¥å¤ç”¨æ²¡æœ‰é‡Šæ”¾<br>ä¸€é¡¿æœç´¢ï¼Œå…³è”åˆ°ç¤¾åŒº issue <a href="https://github.com/kubernetes/kubernetes/issues/87615">https://github.com/kubernetes/kubernetes/issues/87615</a><br>çœ‹èµ·æ¥å°±æ˜¯ golang çš„å¯¹ h2 å¤„ç†çš„ bug</p>
<h2 id="å¤„ç†æ–¹å¼"><a href="#å¤„ç†æ–¹å¼" class="headerlink" title="å¤„ç†æ–¹å¼"></a>å¤„ç†æ–¹å¼</h2><p>ä¿®å¤ä¹Ÿç®€å•ï¼Œæ‰‹åŠ¨é‡å¯ kubelet å³å¯æ¢å¤<br>ä¸»è¦æ‹…å¿ƒå…¶ä»–æœåŠ¡ç”¨ client-go çš„ï¼Œå¯èƒ½ä¹Ÿæœ‰é—®é¢˜ï¼Œè¿ä¸ä¸Šä¸è‡ªæ„ˆï¼Œä½†æ˜¯é™é»˜äº†</p>
<h3 id="æ–¹æ¡ˆ-1-ï¼š-å„æœåŠ¡æ·»åŠ ç¯å¢ƒå˜é‡-DISABLE-HTTP2-trueï¼Œ-å…³é—­-http2"><a href="#æ–¹æ¡ˆ-1-ï¼š-å„æœåŠ¡æ·»åŠ ç¯å¢ƒå˜é‡-DISABLE-HTTP2-trueï¼Œ-å…³é—­-http2" class="headerlink" title="æ–¹æ¡ˆ 1 ï¼š å„æœåŠ¡æ·»åŠ ç¯å¢ƒå˜é‡ DISABLE_HTTP2=trueï¼Œ å…³é—­ http2"></a>æ–¹æ¡ˆ 1 ï¼š å„æœåŠ¡æ·»åŠ ç¯å¢ƒå˜é‡ <code>DISABLE_HTTP2=true</code>ï¼Œ å…³é—­ http2</h3><ul>
<li>å½±å“æ˜¯ï¼Œhttp1.1 æ¨¡å¼ä¸‹å»ºé“¾æ›´å¤šï¼Œä¼šå½±å“ç®¡ç†é¢è´Ÿè½½</li>
<li>å¤šä¸ªæœåŠ¡æ¶‰åŠä¿®æ”¹</li>
</ul>
<h3 id="æ–¹æ¡ˆ-2-ï¼š-http2-ä¸­è¿›è¡Œè§„é¿"><a href="#æ–¹æ¡ˆ-2-ï¼š-http2-ä¸­è¿›è¡Œè§„é¿" class="headerlink" title="æ–¹æ¡ˆ 2 ï¼š http2 ä¸­è¿›è¡Œè§„é¿"></a>æ–¹æ¡ˆ 2 ï¼š http2 ä¸­è¿›è¡Œè§„é¿</h3><p>ä¸€ç•ªå®šä½åï¼Œæ‰¾åˆ°åœ¨ <code>golang.org/x/net/http2/transport.go</code> é‡Œï¼Œä¸‹é¢ä½ç½®æ˜¯é”™è¯¯è¿”å›çš„åœ°æ–¹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">upgradeFn := <span class="function"><span class="keyword">func</span><span class="params">(authority <span class="keyword">string</span>, c *tls.Conn)</span> <span class="title">http</span>.<span class="title">RoundTripper</span></span> &#123;</span><br><span class="line">	addr := authorityAddr(<span class="string">&quot;https&quot;</span>, authority)</span><br><span class="line">	<span class="keyword">if</span> used, err := connPool.addConnIfNeeded(addr, t2, c); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">go</span> c.Close()</span><br><span class="line">		<span class="keyword">return</span> erringRoundTripper&#123;err&#125;    &lt;--- <span class="string">&quot;use of closed network connection&quot;</span>  rised</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è°ƒè¯•ï¼Œå‘ç°æ­¤å¤„ä¸€æ—¦å‘ç”Ÿè¯¥é”™è¯¯ï¼Œå°±æ— æ³•æ­£å¸¸å·¥ä½œäº†ï¼Œç”±æ­¤ä¹Ÿå°±æœ‰äº†ä¸‹é¢ä¿®æ”¹ä»£ç <br>ä¸€æ—¦ä¸€ä¸ª RoundTripper åå¤å¤±è´¥ï¼Œå°±é€€å‡ºè¿›ç¨‹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> exitedRoundTripper <span class="keyword">struct</span>&#123;</span><br><span class="line">	err   error</span><br><span class="line">	count <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *exitedRoundTripper)</span> <span class="title">RoundTrip</span><span class="params">(*http.Request)</span> <span class="params">(*http.Response, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> e.count &gt;<span class="number">10</span> &#123;</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	e.count ++</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, e.err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upgradeFn := <span class="function"><span class="keyword">func</span><span class="params">(authority <span class="keyword">string</span>, c *tls.Conn)</span> <span class="title">http</span>.<span class="title">RoundTripper</span></span> &#123;</span><br><span class="line">  addr := authorityAddr(<span class="string">&quot;https&quot;</span>, authority)</span><br><span class="line">  <span class="keyword">if</span> used, err := connPool.addConnIfNeeded(addr, t2, c); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">go</span> c.Close()</span><br><span class="line">    <span class="keyword">return</span> &amp;exitedRoundTripper&#123;err: err,countter: <span class="number">0</span>&#125;  &lt;-- </span><br><span class="line">  &#125; </span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>kubernetes</tag>
        <tag>golang</tag>
      </tags>
  </entry>
</search>
